name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  deploy:
    name: Deploy to cobyserver.iptime.org
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H cobyserver.iptime.org >> ~/.ssh/known_hosts

      - name: Create remote directory
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@cobyserver.iptime.org "mkdir -p ~/taba_backend"

      - name: Copy files to server
        run: |
          scp -o StrictHostKeyChecking=no docker-compose.yml docker-compose.prod.yml Dockerfile ${{ secrets.SSH_USER }}@cobyserver.iptime.org:~/taba_backend/
          scp -r -o StrictHostKeyChecking=no src/main/resources/db ${{ secrets.SSH_USER }}@cobyserver.iptime.org:~/taba_backend/

      - name: Deploy with Docker Compose
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@cobyserver.iptime.org bash << 'REMOTE_SCRIPT'
            cd ~/taba_backend
            export DB_HOST=mysql
            export DB_PORT=3306
            export DB_NAME='${{ secrets.DB_NAME }}'
            export DB_USERNAME='${{ secrets.DB_USERNAME }}'
            export DB_PASSWORD='${{ secrets.DB_PASSWORD }}'
            export REDIS_HOST=redis
            export REDIS_PORT=6379
            export REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD }}'
            export JWT_SECRET='${{ secrets.JWT_SECRET }}'
            export JWT_EXPIRATION='${{ secrets.JWT_EXPIRATION }}'
            export SERVER_PORT=8080
            export SERVER_URL='${{ secrets.SERVER_URL }}'
            export EXTERNAL_PORT=8080
            export SPRING_PROFILES_ACTIVE=prod
            export FILE_UPLOAD_DIR=/app/uploads
            # ì„ íƒì‚¬í•­ Secrets ê¸°ë³¸ê°’ ì²˜ë¦¬
            [ -z "$JWT_EXPIRATION" ] && export JWT_EXPIRATION=604800000
            [ -z "$REDIS_PASSWORD" ] && export REDIS_PASSWORD=
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml pull || true
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
          REMOTE_SCRIPT

      - name: Check container status
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@cobyserver.iptime.org bash << 'REMOTE_SCRIPT'
            cd ~/taba_backend
            echo "=== Container Status ==="
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
            echo ""
            echo "=== Backend Logs (last 50 lines) ==="
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail=50 backend || true
          REMOTE_SCRIPT

      - name: Health Check
        run: |
          echo "Waiting for application to start..."
          sleep 30
          for i in {1..10}; do
            echo "Health check attempt $i/10..."
            if curl -f http://cobyserver.iptime.org:8080/api/v1/actuator/health; then
              echo "Health check passed!"
              exit 0
            fi
            sleep 10
          done
          echo "Health check failed after 10 attempts"
          exit 1

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ ë°°í¬ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ì„œë²„**: cobyserver.iptime.org" >> $GITHUB_STEP_SUMMARY
          echo "- **í¬íŠ¸**: 8080" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: http://cobyserver.iptime.org:8080/api/v1" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check**: http://cobyserver.iptime.org:8080/api/v1/actuator/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Swagger UI**: http://cobyserver.iptime.org:8080/api/v1/swagger-ui/index.html" >> $GITHUB_STEP_SUMMARY

