name: Deploy to Server

on:
  push:
    branches:
      - main     # ÌîÑÎ°úÎçïÏÖò Î∞∞Ìè¨
      - release  # ÌîÑÎ°úÎçïÏÖò Î∞∞Ìè¨
      - develop   # Í∞úÎ∞ú ÌôòÍ≤Ω Î∞∞Ìè¨
  workflow_dispatch: # ÏàòÎèô Ïã§Ìñâ (ÌôòÍ≤Ω ÏÑ†ÌÉù Í∞ÄÎä•)
    inputs:
      environment:
        description: 'Î∞∞Ìè¨ ÌôòÍ≤Ω ÏÑ†ÌÉù'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy:
    name: Deploy to ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'Production' || github.event.inputs.environment == 'prod' && 'Production' || 'Development' }} Server
    runs-on: ubuntu-latest
    env:
      DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create remote directory
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ~/taba_backend"

      - name: Create Firebase service account key file
        run: |
          mkdir -p src/main/resources
          cat > src/main/resources/firebase-service-account.json << 'EOF'
          ${{ secrets.FCM_SERVICE_ACCOUNT_KEY_JSON }}
          EOF

      - name: Copy files to server
        run: |
          scp -o StrictHostKeyChecking=no docker-compose.dev.yml docker-compose.prod.yml Dockerfile ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/taba_backend/
          scp -o StrictHostKeyChecking=no build.gradle settings.gradle gradle.properties ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/taba_backend/
          scp -r -o StrictHostKeyChecking=no gradle ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/taba_backend/
          scp -r -o StrictHostKeyChecking=no src ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/taba_backend/

      - name: Deploy Application
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash << REMOTE_SCRIPT
            cd ~/taba_backend
            
            # ÌôòÍ≤ΩÎ≥Ñ ÏÑ§Ï†ï Î∂ÑÎ¶¨
            if [ "$DEPLOY_ENV" = "prod" ]; then
              # ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤Ω
              export DB_HOST=mysql
              export DB_PORT=3306
              export DB_NAME='${{ secrets.DB_NAME_PROD }}'
              export DB_USERNAME='${{ secrets.DB_USERNAME_PROD }}'
              export DB_PASSWORD='${{ secrets.DB_PASSWORD_PROD }}'
              export REDIS_HOST=redis
              export REDIS_PORT=6379
              export REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD_PROD }}'
              export JWT_SECRET='${{ secrets.JWT_SECRET_PROD }}'
              export JWT_EXPIRATION='${{ secrets.JWT_EXPIRATION }}'
              export SERVER_PORT=8080
              export SERVER_URL='${{ secrets.SERVER_URL_PROD }}'
              export EXTERNAL_PORT='${{ secrets.EXTERNAL_PORT_PROD }}'
              export SERVER_EXTERNAL_PORT='${{ secrets.EXTERNAL_PORT_PROD }}'
              # ÌîÑÎ°úÎçïÏÖò Í∏∞Î≥∏ Ìè¨Ìä∏: 8080
              [ -z "\$EXTERNAL_PORT" ] && export EXTERNAL_PORT=8080
              [ -z "\$SERVER_EXTERNAL_PORT" ] && export SERVER_EXTERNAL_PORT=8080
              export DB_EXTERNAL_PORT='${{ secrets.DB_EXTERNAL_PORT_PROD }}'
              export REDIS_EXTERNAL_PORT='${{ secrets.REDIS_EXTERNAL_PORT_PROD }}'
              export SPRING_PROFILES_ACTIVE=prod
              export FILE_UPLOAD_DIR=/app/uploads
              COMPOSE_FILE="docker-compose.dev.yml"
              COMPOSE_ENV_FILE="docker-compose.prod.yml"
            else
              # Í∞úÎ∞ú ÌôòÍ≤Ω
              export DB_HOST=mysql
              export DB_PORT=3306
              export DB_NAME='${{ secrets.DB_NAME_DEV }}'
              export DB_USERNAME='${{ secrets.DB_USERNAME_DEV }}'
              export DB_PASSWORD='${{ secrets.DB_PASSWORD_DEV }}'
              export REDIS_HOST=redis
              export REDIS_PORT=6379
              export REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD_DEV }}'
              export JWT_SECRET='${{ secrets.JWT_SECRET_DEV }}'
              export JWT_EXPIRATION='${{ secrets.JWT_EXPIRATION }}'
              export SERVER_PORT=8080
              export SERVER_URL='${{ secrets.SERVER_URL_DEV }}'
              export EXTERNAL_PORT='${{ secrets.EXTERNAL_PORT_DEV }}'
              export SERVER_EXTERNAL_PORT='${{ secrets.EXTERNAL_PORT_DEV }}'
              # Í∞úÎ∞ú ÌôòÍ≤Ω Í∏∞Î≥∏ Ìè¨Ìä∏: 8081
              [ -z "\$EXTERNAL_PORT" ] && export EXTERNAL_PORT=8081
              [ -z "\$SERVER_EXTERNAL_PORT" ] && export SERVER_EXTERNAL_PORT=8081
              export DB_EXTERNAL_PORT='${{ secrets.DB_EXTERNAL_PORT_DEV }}'
              export REDIS_EXTERNAL_PORT='${{ secrets.REDIS_EXTERNAL_PORT_DEV }}'
              export SPRING_PROFILES_ACTIVE=dev
              export FILE_UPLOAD_DIR=/app/uploads
              COMPOSE_FILE="docker-compose.dev.yml"
              COMPOSE_ENV_FILE=""
            fi
            
            # ÏÑ†ÌÉùÏÇ¨Ìï≠ Secrets Í∏∞Î≥∏Í∞í Ï≤òÎ¶¨
            [ -z "\$JWT_EXPIRATION" ] && export JWT_EXPIRATION=604800000
            [ -z "\$REDIS_PASSWORD" ] && export REDIS_PASSWORD=
            # Ìè¨Ìä∏ Í∏∞Î≥∏Í∞íÏùÄ ÏúÑÏóêÏÑú ÌôòÍ≤ΩÎ≥ÑÎ°ú ÏÑ§Ï†ïÎê®
            [ -z "\$DB_EXTERNAL_PORT" ] && export DB_EXTERNAL_PORT=3306
            [ -z "\$REDIS_EXTERNAL_PORT" ] && export REDIS_EXTERNAL_PORT=6379
            
            # ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏ (ÎîîÎ≤ÑÍπÖÏö©, ÎπÑÎ∞ÄÎ≤àÌò∏Îäî ÏùºÎ∂ÄÎßå ÌëúÏãú)
            echo "=== Environment Variables Check ($DEPLOY_ENV) ==="
            echo "DEPLOY_ENV=$DEPLOY_ENV"
            echo "DB_NAME=\$DB_NAME"
            echo "DB_USERNAME=\$DB_USERNAME"
            echo "DB_PASSWORD=\${DB_PASSWORD:0:3}***"
            echo "JWT_SECRET=\${JWT_SECRET:0:10}***"
            echo "SERVER_URL=\$SERVER_URL"
            echo "EXTERNAL_PORT=\$EXTERNAL_PORT"
            echo "DB_EXTERNAL_PORT=\$DB_EXTERNAL_PORT"
            echo "REDIS_EXTERNAL_PORT=\$REDIS_EXTERNAL_PORT"
            echo "================================"
            
            # Docker Compose Î™ÖÎ†πÏñ¥ Íµ¨ÏÑ±
            if [ -n "\$COMPOSE_ENV_FILE" ]; then
              COMPOSE_CMD="docker-compose -f \$COMPOSE_FILE -f \$COMPOSE_ENV_FILE"
            else
              COMPOSE_CMD="docker-compose -f \$COMPOSE_FILE"
            fi
            
            # Î∞∞Ìè¨ ÏãúÏûë
            echo "=== Starting deployment for $DEPLOY_ENV environment ==="
            
            # ÌôòÍ≤ΩÎ≥Ñ Î∞±ÏóîÎìú Ïª®ÌÖåÏù¥ÎÑà Ïù¥Î¶Ñ ÏÑ§Ï†ï
            if [ "$DEPLOY_ENV" = "prod" ]; then
              BACKEND_CONTAINER="taba-backend-prod"
              MYSQL_CONTAINER="taba-mysql-prod"
              REDIS_CONTAINER="taba-redis-prod"
            else
              BACKEND_CONTAINER="taba-backend-dev"
              MYSQL_CONTAINER="taba-mysql-dev"
              REDIS_CONTAINER="taba-redis-dev"
            fi
            
            echo "Target containers:"
            echo "  Backend: \$BACKEND_CONTAINER"
            echo "  MySQL: \$MYSQL_CONTAINER"
            echo "  Redis: \$REDIS_CONTAINER"
            echo ""
            
            # 1. Ìï¥Îãπ ÌôòÍ≤ΩÏùò Î∞±ÏóîÎìú Ïª®ÌÖåÏù¥ÎÑàÎßå Ï§ëÏßÄ Î∞è Ï†úÍ±∞ (Îã§Î•∏ ÌôòÍ≤ΩÏùÄ Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå)
            echo "Stopping existing backend container (\$BACKEND_CONTAINER)..."
            docker stop \$BACKEND_CONTAINER 2>/dev/null || true
            docker rm -f \$BACKEND_CONTAINER 2>/dev/null || true
            
            # 2. ÏÉà Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
            echo "Building new backend image for $DEPLOY_ENV..."
            if ! \$COMPOSE_CMD build --no-cache --progress=plain backend; then
              echo "‚ùå Image build failed!"
              exit 1
            fi
            
            # 3. Ìï¥Îãπ ÌôòÍ≤ΩÏùò MySQL, Redis ÏãúÏûë (Îã§Î•∏ ÌôòÍ≤ΩÏùÄ Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå)
            echo "Ensuring MySQL and Redis are running for $DEPLOY_ENV..."
            
            # ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉùÏÑ± (ÏóÜÏúºÎ©¥)
            docker network create taba-network 2>/dev/null || true
            
            # Ìï¥Îãπ ÌôòÍ≤ΩÏùò MySQL, Redis Ïª®ÌÖåÏù¥ÎÑà ÌôïÏù∏
            MYSQL_RUNNING=\$(docker ps -q -f name=\$MYSQL_CONTAINER) || true
            REDIS_RUNNING=\$(docker ps -q -f name=\$REDIS_CONTAINER) || true
            
            # MySQL, RedisÍ∞Ä ÏóÜÍ±∞ÎÇò Ï§ëÏßÄÎêú Í≤ΩÏö∞ Ïû¨ÏÉùÏÑ±
            if [ -z "\$MYSQL_RUNNING" ] || [ -z "\$REDIS_RUNNING" ]; then
              echo "Starting MySQL and Redis for $DEPLOY_ENV..."
              
              # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà ÏôÑÏ†ÑÌûà Ï†úÍ±∞ (ÏûàÏúºÎ©¥)
              docker stop \$MYSQL_CONTAINER \$REDIS_CONTAINER 2>/dev/null || true
              docker rm -f \$MYSQL_CONTAINER \$REDIS_CONTAINER 2>/dev/null || true
              
              # MySQL, Redis ÏãúÏûë (ÌôòÍ≤Ω Î≥ÄÏàòÏôÄ Ìï®Íªò)
              echo "Starting MySQL and Redis with environment variables..."
              echo "DB_NAME=\$DB_NAME"
              echo "DB_USERNAME=\$DB_USERNAME"
              echo "DB_PASSWORD=\${DB_PASSWORD:0:3}***"
              
              # docker-composeÎ°ú ÏãúÏûë ÏãúÎèÑ
              if ! \$COMPOSE_CMD up -d mysql redis 2>&1; then
                echo "‚ö†Ô∏è docker-compose up failed, checking if containers were created..."
              fi
              
              # Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä Ïã§Ï†úÎ°ú Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏
              sleep 5
              MYSQL_CHECK=\$(docker ps -q -f name=\$MYSQL_CONTAINER) || true
              REDIS_CHECK=\$(docker ps -q -f name=\$REDIS_CONTAINER) || true
              
              if [ -z "\$MYSQL_CHECK" ] || [ -z "\$REDIS_CHECK" ]; then
                echo "‚ö†Ô∏è Warning: MySQL or Redis containers may not be running properly"
                echo "MySQL (\$MYSQL_CONTAINER) running: \$([ -n "\$MYSQL_CHECK" ] && echo 'yes' || echo 'no')"
                echo "Redis (\$REDIS_CONTAINER) running: \$([ -n "\$REDIS_CHECK" ] && echo 'yes' || echo 'no')"
                echo "MySQL logs:"
                docker logs --tail=30 \$MYSQL_CONTAINER 2>&1 || echo "No MySQL logs"
                echo "Redis logs:"
                docker logs --tail=30 \$REDIS_CONTAINER 2>&1 || echo "No Redis logs"
              else
                echo "‚úÖ MySQL and Redis are running for $DEPLOY_ENV"
              fi
            else
              echo "‚úÖ MySQL and Redis are already running for $DEPLOY_ENV"
              echo "Checking MySQL container status..."
              docker ps --filter "name=\$MYSQL_CONTAINER" --format "table {{.Names}}\t{{.Status}}" || true
            fi
            
            # MySQL Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Î∞è Ïû¨ÏÉùÏÑ± Î°úÏßÅ Í∞ïÌôî
            echo "=== Testing MySQL connection ==="
            MAX_MYSQL_RETRIES=3
            MYSQL_CONNECTION_OK=false
            
            for retry in \$(seq 1 \$MAX_MYSQL_RETRIES); do
              echo "MySQL connection test attempt \$retry/\$MAX_MYSQL_RETRIES..."
              
              # MySQL Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏
              if ! docker ps | grep -q "\$MYSQL_CONTAINER"; then
                echo "‚ö†Ô∏è MySQL container is not running. Starting it..."
                \$COMPOSE_CMD up -d mysql
                echo "Waiting for MySQL to be ready..."
                sleep 15
              fi
              
              # MySQL Ìó¨Ïä§Ï≤¥ÌÅ¨ ÎåÄÍ∏∞ (ÏµúÎåÄ 60Ï¥à)
              echo "Waiting for MySQL health check..."
              for i in {1..12}; do
                if docker inspect --format='{{.State.Health.Status}}' \$MYSQL_CONTAINER 2>/dev/null | grep -q "healthy"; then
                  echo "‚úÖ MySQL is healthy"
                  break
                fi
                if [ \$i -eq 12 ]; then
                  echo "‚ö†Ô∏è MySQL health check timeout, but continuing..."
                fi
                sleep 5
              done
              
              # Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ (rootÎ°ú Î®ºÏ†Ä ÏãúÎèÑ, Í∑∏ Îã§Ïùå ÏÇ¨Ïö©Ïûê Í≥ÑÏ†ï)
              echo "Testing MySQL connection as root..."
              ROOT_TEST=\$(docker exec \$MYSQL_CONTAINER mysql -u root -p\${DB_PASSWORD} -e "SELECT 1" 2>&1) || true
              
              if echo "\$ROOT_TEST" | grep -qiE "(ERROR|Access denied|denied)"; then
                echo "‚ö†Ô∏è Root connection failed. Test result: \$ROOT_TEST"
              else
                echo "‚úÖ Root connection successful"
                
                # ÏÇ¨Ïö©Ïûê Í≥ÑÏ†ïÏúºÎ°ú Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
                echo "Testing MySQL connection as \$DB_USERNAME..."
                USER_TEST=\$(docker exec \$MYSQL_CONTAINER mysql -u \$DB_USERNAME -p\$DB_PASSWORD -e "SELECT 1" 2>&1) || true
                
                if echo "\$USER_TEST" | grep -qiE "(ERROR|Access denied|denied)"; then
                  echo "‚ö†Ô∏è User connection failed. Attempting to fix user permissions..."
                  echo "Test result: \$USER_TEST"
                  
                  # MySQLÏóêÏÑú ÏÇ¨Ïö©Ïûê Ïû¨ÏÉùÏÑ± ÏãúÎèÑ
                  echo "Recreating MySQL user \$DB_USERNAME..."
                  docker exec \$MYSQL_CONTAINER mysql -u root -p\${DB_PASSWORD} -e "CREATE DATABASE IF NOT EXISTS \`\$DB_NAME\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; DROP USER IF EXISTS '\$DB_USERNAME'@'%'; CREATE USER '\$DB_USERNAME'@'%' IDENTIFIED BY '\$DB_PASSWORD'; GRANT ALL PRIVILEGES ON \`\$DB_NAME\`.* TO '\$DB_USERNAME'@'%'; FLUSH PRIVILEGES;" 2>&1 || echo "Failed to recreate user"
                  
                  sleep 3
                  
                  # Îã§Ïãú ÌÖåÏä§Ìä∏
                  USER_TEST=\$(docker exec \$MYSQL_CONTAINER mysql -u \$DB_USERNAME -p\$DB_PASSWORD -e "SELECT 1" 2>&1) || true
                  if echo "\$USER_TEST" | grep -qiE "(ERROR|Access denied|denied)"; then
                    echo "‚ö†Ô∏è User connection still failing after fix attempt"
                  else
                    echo "‚úÖ User connection successful after fix"
                    MYSQL_CONNECTION_OK=true
                    break
                  fi
                else
                  echo "‚úÖ User connection successful"
                  MYSQL_CONNECTION_OK=true
                  break
                fi
              fi
              
              # Ïó∞Í≤∞ Ïã§Ìå® Ïãú MySQL Ïª®ÌÖåÏù¥ÎÑà Ïû¨ÏÉùÏÑ±
              if [ \$retry -lt \$MAX_MYSQL_RETRIES ]; then
                echo "‚ö†Ô∏è MySQL connection test failed (attempt \$retry). Recreating MySQL container..."
                echo "Stopping and removing MySQL container..."
                docker stop \$MYSQL_CONTAINER 2>/dev/null || true
                docker rm -f \$MYSQL_CONTAINER 2>/dev/null || true
                
                echo "Recreating MySQL container with correct credentials..."
                echo "DB_NAME=\$DB_NAME"
                echo "DB_USERNAME=\$DB_USERNAME"
                echo "DB_PASSWORD=\${DB_PASSWORD:0:3}***"
                
                \$COMPOSE_CMD up -d mysql
                
                echo "Waiting for MySQL to initialize..."
                sleep 20
                
                # MySQL Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞
                for i in {1..20}; do
                  if docker logs \$MYSQL_CONTAINER 2>&1 | grep -q "ready for connections"; then
                    echo "‚úÖ MySQL is ready for connections"
                    break
                  fi
                  if [ \$i -eq 20 ]; then
                    echo "‚ö†Ô∏è MySQL initialization timeout, but continuing..."
                  fi
                  sleep 3
                done
              fi
            done
            
            if [ "\$MYSQL_CONNECTION_OK" != "true" ]; then
              echo "‚ùå MySQL connection test failed after \$MAX_MYSQL_RETRIES attempts!"
              echo "=== MySQL Container Logs ==="
              docker logs --tail=50 \$MYSQL_CONTAINER 2>&1 || echo "No logs available"
              echo "=== MySQL Container Status ==="
              docker ps -a | grep \$MYSQL_CONTAINER || echo "Container not found"
              echo "=== Environment Variables ==="
              echo "DB_NAME=\$DB_NAME"
              echo "DB_USERNAME=\$DB_USERNAME"
              echo "DB_PASSWORD=\${DB_PASSWORD:0:3}***"
              exit 1
            fi
            
            echo "‚úÖ MySQL connection test passed successfully"
            
            # 4. MySQL, Redis Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏµúÏ¢Ö ÌôïÏù∏
            echo "=== Final health check for MySQL and Redis ==="
            sleep 5
            
            # 5. Ìï¥Îãπ ÌôòÍ≤ΩÏùò Î∞±ÏóîÎìú ÏÑúÎπÑÏä§ ÏãúÏûë (Îã§Î•∏ ÌôòÍ≤ΩÏùÄ Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå)
            echo "Starting backend service (\$BACKEND_CONTAINER)..."
            if ! \$COMPOSE_CMD up -d backend; then
              echo "‚ùå Backend service start failed!"
              echo "=== Backend Logs ==="
              \$COMPOSE_CMD logs --tail=100 backend 2>&1 || true
              exit 1
            fi
            
            # 6. Î™®Îì† ÌôòÍ≤ΩÏùò Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
            echo ""
            echo "=== All Container Status ==="
            echo "--- Development Environment ---"
            docker ps -a --filter "name=taba-backend-dev" --filter "name=taba-mysql-dev" --filter "name=taba-redis-dev" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
            echo ""
            echo "--- Production Environment ---"
            docker ps -a --filter "name=taba-backend-prod" --filter "name=taba-mysql-prod" --filter "name=taba-redis-prod" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
            
            echo "‚úÖ Deployment completed for $DEPLOY_ENV environment"
            echo ""
            echo "=== Deployed Backend Logs (first 50 lines) ==="
            sleep 5
            docker logs --tail=50 \$BACKEND_CONTAINER 2>&1 || echo "No logs available"
          REMOTE_SCRIPT
        env:
          DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}

      - name: Check container status
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash << REMOTE_SCRIPT
            cd ~/taba_backend
            if [ "$DEPLOY_ENV" = "prod" ]; then
              COMPOSE_FILE="docker-compose.dev.yml"
              COMPOSE_ENV_FILE="docker-compose.prod.yml"
            else
              COMPOSE_FILE="docker-compose.dev.yml"
              COMPOSE_ENV_FILE=""
            fi
            
            echo "=== Docker Compose Configuration Check ==="
            if [ -n "\$COMPOSE_ENV_FILE" ]; then
              echo "Checking docker-compose config..."
              docker-compose -f \$COMPOSE_FILE -f \$COMPOSE_ENV_FILE config 2>&1 | head -50 || echo "Config check failed"
            else
              echo "Checking docker-compose config..."
              docker-compose -f \$COMPOSE_FILE config 2>&1 | head -50 || echo "Config check failed"
            fi
            echo ""
            
            echo "=== All Docker Containers ==="
            docker ps -a || echo "docker ps -a failed"
            echo ""
            
            echo "=== Docker Images ==="
            docker images | grep -E "(taba|backend|mysql|redis)" || echo "No relevant images found"
            echo ""
            
            echo "=== Container Status (All Environments) ==="
            echo ""
            echo "--- Development Environment ---"
            docker ps -a --filter "name=taba-backend-dev" --filter "name=taba-mysql-dev" --filter "name=taba-redis-dev" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || echo "No dev containers found"
            echo ""
            echo "--- Production Environment ---"
            docker ps -a --filter "name=taba-backend-prod" --filter "name=taba-mysql-prod" --filter "name=taba-redis-prod" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || echo "No prod containers found"
            echo ""
            
            # Î∞∞Ìè¨Îêú ÌôòÍ≤ΩÏùò Î∞±ÏóîÎìú Î°úÍ∑∏Îßå ÌôïÏù∏
            if [ "$DEPLOY_ENV" = "prod" ]; then
              BACKEND_CONTAINER="taba-backend-prod"
            else
              BACKEND_CONTAINER="taba-backend-dev"
            fi
            
            echo "=== Deployed Backend Logs (\$BACKEND_CONTAINER, last 100 lines) ==="
            docker logs --tail=100 \$BACKEND_CONTAINER 2>&1 || echo "No logs available (container may not exist)"
            echo ""
            echo "=== Deployed Backend Logs (with timestamps, last 200 lines) ==="
            docker logs --tail=200 --timestamps \$BACKEND_CONTAINER 2>&1 | tail -50 || echo "No logs available"
            echo ""
            
            echo "=== Checking if backend containers exist ==="
            if docker ps -a | grep -q "taba-backend-dev"; then
              echo "‚úÖ Development backend container exists"
              docker ps -a | grep "taba-backend-dev"
            else
              echo "‚ö†Ô∏è Development backend container does not exist"
            fi
            echo ""
            if docker ps -a | grep -q "taba-backend-prod"; then
              echo "‚úÖ Production backend container exists"
              docker ps -a | grep "taba-backend-prod"
            else
              echo "‚ö†Ô∏è Production backend container does not exist"
            fi
          REMOTE_SCRIPT
        env:
          DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}

      - name: Health Check (Internal)
        continue-on-error: true
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash << REMOTE_SCRIPT
            cd ~/taba_backend
            if [ "$DEPLOY_ENV" = "prod" ]; then
              COMPOSE_FILE="docker-compose.dev.yml"
              COMPOSE_ENV_FILE="docker-compose.prod.yml"
            else
              COMPOSE_FILE="docker-compose.dev.yml"
              COMPOSE_ENV_FILE=""
            fi
            # Î∞∞Ìè¨Îêú ÌôòÍ≤ΩÏùò Î∞±ÏóîÎìú Ïª®ÌÖåÏù¥ÎÑà Ïù¥Î¶Ñ ÏÑ§Ï†ï
            if [ "$DEPLOY_ENV" = "prod" ]; then
              BACKEND_CONTAINER="taba-backend-prod"
            else
              BACKEND_CONTAINER="taba-backend-dev"
            fi
            
            echo "Waiting for application to start (\$BACKEND_CONTAINER)..."
            sleep 60
            for i in {1..15}; do
              echo "Health check attempt \$i/15 (internal) for \$BACKEND_CONTAINER..."
              # Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏
              if ! docker ps | grep -q "\$BACKEND_CONTAINER"; then
                echo "Container is not running. Checking logs..."
                docker logs --tail=50 \$BACKEND_CONTAINER 2>&1 || echo "No logs available"
                sleep 10
                continue
              fi
              # Health check ÏãúÎèÑ
              if docker exec \$BACKEND_CONTAINER wget --no-verbose --tries=1 --spider http://localhost:8080/api/v1/actuator/health 2>&1 || docker exec \$BACKEND_CONTAINER curl -f http://localhost:8080/api/v1/actuator/health 2>&1; then
                echo "Health check passed for \$BACKEND_CONTAINER!"
                exit 0
              fi
              sleep 10
            done
            echo "Health check failed after 15 attempts for \$BACKEND_CONTAINER"
            echo "=== Final Backend Logs ==="
            docker logs --tail=100 \$BACKEND_CONTAINER 2>&1 || echo "No logs available"
            exit 1
          REMOTE_SCRIPT
        env:
          DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}

      - name: Health Check (External) - Optional
        continue-on-error: true
        run: |
          DEPLOY_ENV="${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}"
          if [ "$DEPLOY_ENV" = "prod" ]; then
            SERVER_URL='${{ secrets.SERVER_URL_PROD }}'
          else
            SERVER_URL='${{ secrets.SERVER_URL_DEV }}'
          fi
          echo "Checking external health endpoint..."
          echo "DEPLOY_ENV: $DEPLOY_ENV"
          echo "SERVER_URL: ${SERVER_URL:0:20}..." # Ï≤òÏùå 20ÏûêÎßå ÌëúÏãú
          # SERVER_URLÏù¥ ÎπÑÏñ¥ÏûàÍ±∞ÎÇò ÏûòÎ™ªÎêú ÌòïÏãùÏù∏ÏßÄ ÌôïÏù∏
          if [ -z "$SERVER_URL" ] || [ "$SERVER_URL" = "null" ] || [[ "$SERVER_URL" == *"***"* ]]; then
            echo "SERVER_URL not properly set, skipping external health check"
            exit 0
          fi
          # SERVER_URLÏóêÏÑú ÎèÑÎ©îÏù∏ Ï∂îÏ∂ú (https://api.example.com/api/v1 -> https://api.example.com)
          SERVER_DOMAIN=$(echo "$SERVER_URL" | sed 's|https\?://||' | sed 's|/.*||')
          if [ -n "$SERVER_DOMAIN" ] && [ "$SERVER_DOMAIN" != "null" ]; then
            curl -f https://${SERVER_DOMAIN}/api/v1/actuator/health || echo "External health check failed"
          else
            echo "SERVER_URL not set, skipping external health check"
          fi

      - name: Deployment Summary
        run: |
          DEPLOY_ENV="${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}"
          if [ "$DEPLOY_ENV" = "prod" ]; then
            SERVER_URL='${{ secrets.SERVER_URL_PROD }}'
            ENV_NAME="ÌîÑÎ°úÎçïÏÖò"
          else
            SERVER_URL='${{ secrets.SERVER_URL_DEV }}'
            ENV_NAME="Í∞úÎ∞ú"
          fi
          SERVER_DOMAIN=$(echo "$SERVER_URL" | sed 's|https\?://||' | sed 's|/.*||' 2>/dev/null || echo "")
          echo "## üöÄ $ENV_NAME Î∞∞Ìè¨ ÏôÑÎ£å!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ÌôòÍ≤Ω**: $ENV_NAME" >> $GITHUB_STEP_SUMMARY
          if [ -n "$SERVER_DOMAIN" ] && [ "$SERVER_DOMAIN" != "null" ] && [[ ! "$SERVER_DOMAIN" == *"***"* ]]; then
            echo "- **ÏÑúÎ≤Ñ**: $SERVER_DOMAIN" >> $GITHUB_STEP_SUMMARY
            echo "- **API URL**: $SERVER_URL" >> $GITHUB_STEP_SUMMARY
            echo "- **Health Check**: $SERVER_URL/actuator/health" >> $GITHUB_STEP_SUMMARY
            echo "- **Swagger UI**: $SERVER_URL/swagger-ui/index.html" >> $GITHUB_STEP_SUMMARY
          else
            DEPLOY_ENV_UPPER=$(echo "$DEPLOY_ENV" | tr '[:lower:]' '[:upper:]')
            echo "- **ÏÑúÎ≤Ñ**: GitHub SecretsÏóêÏÑú SERVER_URL_${DEPLOY_ENV_UPPER} ÏÑ§Ï†ï ÌïÑÏöî" >> $GITHUB_STEP_SUMMARY
            echo "- **API URL**: ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏùå" >> $GITHUB_STEP_SUMMARY
          fi

