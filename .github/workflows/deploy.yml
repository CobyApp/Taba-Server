name: Deploy to Server

on:
  push:
    branches:
      - main     # í”„ë¡œë•ì…˜ ë°°í¬
      - release  # í”„ë¡œë•ì…˜ ë°°í¬
      - develop   # ê°œë°œ í™˜ê²½ ë°°í¬
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ (í™˜ê²½ ì„ íƒ ê°€ëŠ¥)
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy:
    name: Deploy to ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'Production' || github.event.inputs.environment == 'prod' && 'Production' || 'Development' }} Server
    runs-on: ubuntu-latest
    env:
      DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create remote directory
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ~/taba_backend"

      - name: Create Firebase service account key file
        run: |
          mkdir -p src/main/resources
          cat > src/main/resources/firebase-service-account.json << 'EOF'
          ${{ secrets.FCM_SERVICE_ACCOUNT_KEY_JSON }}
          EOF

      - name: Copy files to server
        run: |
          scp -o StrictHostKeyChecking=no docker-compose.dev.yml docker-compose.prod.yml Dockerfile ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/taba_backend/
          scp -o StrictHostKeyChecking=no build.gradle settings.gradle gradle.properties ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/taba_backend/
          scp -r -o StrictHostKeyChecking=no gradle ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/taba_backend/
          scp -r -o StrictHostKeyChecking=no src ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/taba_backend/

      - name: Deploy Application
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash << REMOTE_SCRIPT
            cd ~/taba_backend
            
            # í™˜ê²½ë³„ ì„¤ì • ë¶„ë¦¬
            if [ "$DEPLOY_ENV" = "prod" ]; then
              # í”„ë¡œë•ì…˜ í™˜ê²½
              export DB_HOST=mysql
              export DB_PORT=3306
              export DB_NAME='${{ secrets.DB_NAME_PROD }}'
              export DB_USERNAME='${{ secrets.DB_USERNAME_PROD }}'
              export DB_PASSWORD='${{ secrets.DB_PASSWORD_PROD }}'
              export REDIS_HOST=redis
              export REDIS_PORT=6379
              export REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD_PROD }}'
              export JWT_SECRET='${{ secrets.JWT_SECRET_PROD }}'
              export JWT_EXPIRATION='${{ secrets.JWT_EXPIRATION }}'
              export SERVER_PORT=8080
              export SERVER_URL='${{ secrets.SERVER_URL_PROD }}'
              export EXTERNAL_PORT='${{ secrets.EXTERNAL_PORT_PROD }}'
              export SERVER_EXTERNAL_PORT='${{ secrets.EXTERNAL_PORT_PROD }}'
              export DB_EXTERNAL_PORT='${{ secrets.DB_EXTERNAL_PORT_PROD }}'
              export REDIS_EXTERNAL_PORT='${{ secrets.REDIS_EXTERNAL_PORT_PROD }}'
              export SPRING_PROFILES_ACTIVE=prod
              export FILE_UPLOAD_DIR=/app/uploads
              COMPOSE_FILE="docker-compose.dev.yml"
              COMPOSE_ENV_FILE="docker-compose.prod.yml"
            else
              # ê°œë°œ í™˜ê²½
              export DB_HOST=mysql
              export DB_PORT=3306
              export DB_NAME='${{ secrets.DB_NAME_DEV }}'
              export DB_USERNAME='${{ secrets.DB_USERNAME_DEV }}'
              export DB_PASSWORD='${{ secrets.DB_PASSWORD_DEV }}'
              export REDIS_HOST=redis
              export REDIS_PORT=6379
              export REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD_DEV }}'
              export JWT_SECRET='${{ secrets.JWT_SECRET_DEV }}'
              export JWT_EXPIRATION='${{ secrets.JWT_EXPIRATION }}'
              export SERVER_PORT=8080
              export SERVER_URL='${{ secrets.SERVER_URL_DEV }}'
              export EXTERNAL_PORT='${{ secrets.EXTERNAL_PORT_DEV }}'
              export SERVER_EXTERNAL_PORT='${{ secrets.EXTERNAL_PORT_DEV }}'
              export DB_EXTERNAL_PORT='${{ secrets.DB_EXTERNAL_PORT_DEV }}'
              export REDIS_EXTERNAL_PORT='${{ secrets.REDIS_EXTERNAL_PORT_DEV }}'
              export SPRING_PROFILES_ACTIVE=dev
              export FILE_UPLOAD_DIR=/app/uploads
              COMPOSE_FILE="docker-compose.dev.yml"
              COMPOSE_ENV_FILE=""
            fi
            
            # ì„ íƒì‚¬í•­ Secrets ê¸°ë³¸ê°’ ì²˜ë¦¬
            [ -z "\$JWT_EXPIRATION" ] && export JWT_EXPIRATION=604800000
            [ -z "\$REDIS_PASSWORD" ] && export REDIS_PASSWORD=
            [ -z "\$EXTERNAL_PORT" ] && export EXTERNAL_PORT=8080
            [ -z "\$DB_EXTERNAL_PORT" ] && export DB_EXTERNAL_PORT=3306
            [ -z "\$REDIS_EXTERNAL_PORT" ] && export REDIS_EXTERNAL_PORT=6379
            
            # í™˜ê²½ ë³€ìˆ˜ í™•ì¸ (ë””ë²„ê¹…ìš©, ë¹„ë°€ë²ˆí˜¸ëŠ” ì¼ë¶€ë§Œ í‘œì‹œ)
            echo "=== Environment Variables Check ($DEPLOY_ENV) ==="
            echo "DEPLOY_ENV=$DEPLOY_ENV"
            echo "DB_NAME=\$DB_NAME"
            echo "DB_USERNAME=\$DB_USERNAME"
            echo "DB_PASSWORD=\${DB_PASSWORD:0:3}***"
            echo "JWT_SECRET=\${JWT_SECRET:0:10}***"
            echo "SERVER_URL=\$SERVER_URL"
            echo "EXTERNAL_PORT=\$EXTERNAL_PORT"
            echo "DB_EXTERNAL_PORT=\$DB_EXTERNAL_PORT"
            echo "REDIS_EXTERNAL_PORT=\$REDIS_EXTERNAL_PORT"
            echo "================================"
            
            # Docker Compose ëª…ë ¹ì–´ êµ¬ì„±
            if [ -n "\$COMPOSE_ENV_FILE" ]; then
              COMPOSE_CMD="docker-compose -f \$COMPOSE_FILE -f \$COMPOSE_ENV_FILE"
            else
              COMPOSE_CMD="docker-compose -f \$COMPOSE_FILE"
            fi
            
            # ë°°í¬ ì‹œìž‘
            echo "=== Starting deployment ==="
            
            # 1. ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆë§Œ ì¤‘ì§€ ë° ì œê±° (MySQL, RedisëŠ” ìœ ì§€)
            echo "Stopping existing backend container..."
            \$COMPOSE_CMD stop backend || true
            \$COMPOSE_CMD rm -f backend || true
            
            # 2. ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ
            echo "Building new backend image..."
            if ! \$COMPOSE_CMD build --no-cache --progress=plain backend; then
              echo "âŒ Image build failed!"
              exit 1
            fi
            
            # 3. MySQL, Redis ì‹œìž‘ (ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ í›„ ìž¬ì‹œìž‘)
            echo "Ensuring MySQL and Redis are running..."
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "Checking existing MySQL and Redis containers..."
            MYSQL_RUNNING=\$(docker ps -q -f name=taba-mysql) || true
            REDIS_RUNNING=\$(docker ps -q -f name=taba-redis) || true
            
            # ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆê°€ ìžˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©, ì—†ìœ¼ë©´ ì‹œìž‘ ì‹œë„
            if [ -n "\$MYSQL_RUNNING" ] && [ -n "\$REDIS_RUNNING" ]; then
              echo "MySQL and Redis are already running. Skipping restart."
            else
              echo "Starting or restarting MySQL and Redis..."
              
              # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±° (ì—ëŸ¬ ë¬´ì‹œ)
              \$COMPOSE_CMD stop mysql redis 2>/dev/null || true
              \$COMPOSE_CMD rm -f mysql redis 2>/dev/null || true
              
              # ì†ìƒëœ ì»¨í…Œì´ë„ˆ ê°•ì œ ì œê±°
              docker rm -f taba-mysql-dev taba-mysql-prod taba-redis-dev taba-redis-prod 2>/dev/null || true
              
              # ë„¤íŠ¸ì›Œí¬ ìƒì„± (ì—†ìœ¼ë©´)
              docker network create taba-network 2>/dev/null || true
              
              # MySQL, Redis ì‹œìž‘ (docker-compose ì‚¬ìš©)
              echo "Starting MySQL and Redis with docker-compose..."
              if ! \$COMPOSE_CMD up -d mysql redis 2>&1; then
                echo "âš ï¸ docker-compose up failed, but continuing..."
                # docker-composeê°€ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ì»¨í…Œì´ë„ˆê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¼ ìˆ˜ ìžˆìŒ)
              fi
              
              # ì»¨í…Œì´ë„ˆê°€ ì‹¤ì œë¡œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
              sleep 3
              MYSQL_CHECK=\$(docker ps -q -f name=taba-mysql) || true
              REDIS_CHECK=\$(docker ps -q -f name=taba-redis) || true
              
              if [ -z "\$MYSQL_CHECK" ] || [ -z "\$REDIS_CHECK" ]; then
                echo "âš ï¸ Warning: MySQL or Redis containers may not be running properly"
                echo "MySQL running: \$([ -n "\$MYSQL_CHECK" ] && echo 'yes' || echo 'no')"
                echo "Redis running: \$([ -n "\$REDIS_CHECK" ] && echo 'yes' || echo 'no')"
              fi
            fi
            
            # 4. MySQL, Redis í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
            echo "Waiting for MySQL and Redis to be healthy..."
            sleep 10
            
            # 5. ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œìž‘
            echo "Starting backend service..."
            if ! \$COMPOSE_CMD up -d backend; then
              echo "âŒ Backend service start failed!"
              echo "=== Backend Logs ==="
              \$COMPOSE_CMD logs --tail=100 backend 2>&1 || true
              exit 1
            fi
            
            echo "âœ… Deployment completed"
            echo ""
            echo "=== Container Status ==="
            \$COMPOSE_CMD ps || echo "docker-compose ps failed"
            echo ""
            echo "=== Backend Logs (first 50 lines) ==="
            sleep 5
            \$COMPOSE_CMD logs --tail=50 backend 2>&1 || echo "No logs available"
          REMOTE_SCRIPT
        env:
          DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}

      - name: Check container status
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash << REMOTE_SCRIPT
            cd ~/taba_backend
            if [ "$DEPLOY_ENV" = "prod" ]; then
              COMPOSE_FILE="docker-compose.dev.yml"
              COMPOSE_ENV_FILE="docker-compose.prod.yml"
            else
              COMPOSE_FILE="docker-compose.dev.yml"
              COMPOSE_ENV_FILE=""
            fi
            
            echo "=== Docker Compose Configuration Check ==="
            if [ -n "\$COMPOSE_ENV_FILE" ]; then
              echo "Checking docker-compose config..."
              docker-compose -f \$COMPOSE_FILE -f \$COMPOSE_ENV_FILE config 2>&1 | head -50 || echo "Config check failed"
            else
              echo "Checking docker-compose config..."
              docker-compose -f \$COMPOSE_FILE config 2>&1 | head -50 || echo "Config check failed"
            fi
            echo ""
            
            echo "=== All Docker Containers ==="
            docker ps -a || echo "docker ps -a failed"
            echo ""
            
            echo "=== Docker Images ==="
            docker images | grep -E "(taba|backend|mysql|redis)" || echo "No relevant images found"
            echo ""
            
            echo "=== Container Status ==="
            if [ -n "\$COMPOSE_ENV_FILE" ]; then
              docker-compose -f \$COMPOSE_FILE -f \$COMPOSE_ENV_FILE ps || echo "docker-compose ps failed"
              echo ""
              echo "=== Backend Logs (last 100 lines) ==="
              docker-compose -f \$COMPOSE_FILE -f \$COMPOSE_ENV_FILE logs --tail=100 backend 2>&1 || echo "No logs available (container may not exist)"
              echo ""
              echo "=== Backend Logs (with timestamps, last 200 lines) ==="
              docker-compose -f \$COMPOSE_FILE -f \$COMPOSE_ENV_FILE logs --tail=200 --timestamps backend 2>&1 | tail -50 || echo "No logs available"
            else
              docker-compose -f \$COMPOSE_FILE ps || echo "docker-compose ps failed"
              echo ""
              echo "=== Backend Logs (last 100 lines) ==="
              docker-compose -f \$COMPOSE_FILE logs --tail=100 backend 2>&1 || echo "No logs available (container may not exist)"
              echo ""
              echo "=== Backend Logs (with timestamps, last 200 lines) ==="
              docker-compose -f \$COMPOSE_FILE logs --tail=200 --timestamps backend 2>&1 | tail -50 || echo "No logs available"
            fi
            echo ""
            
            echo "=== Checking if backend container exists ==="
            if docker ps -a | grep -q "taba-backend"; then
              echo "Backend container exists"
              docker ps -a | grep "taba-backend"
            else
              echo "Backend container does not exist!"
              echo "This suggests the deployment may have failed."
            fi
          REMOTE_SCRIPT
        env:
          DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}

      - name: Health Check (Internal)
        continue-on-error: true
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash << REMOTE_SCRIPT
            cd ~/taba_backend
            if [ "$DEPLOY_ENV" = "prod" ]; then
              COMPOSE_FILE="docker-compose.dev.yml"
              COMPOSE_ENV_FILE="docker-compose.prod.yml"
            else
              COMPOSE_FILE="docker-compose.dev.yml"
              COMPOSE_ENV_FILE=""
            fi
            echo "Waiting for application to start..."
            sleep 60
            for i in {1..15}; do
              echo "Health check attempt \$i/15 (internal)..."
              # ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
              if [ -n "\$COMPOSE_ENV_FILE" ]; then
                if ! docker-compose -f \$COMPOSE_FILE -f \$COMPOSE_ENV_FILE ps backend | grep -q "Up"; then
                  echo "Container is not running. Checking logs..."
                  docker-compose -f \$COMPOSE_FILE -f \$COMPOSE_ENV_FILE logs --tail=50 backend
                  sleep 10
                  continue
                fi
                # Health check ì‹œë„
                if docker-compose -f \$COMPOSE_FILE -f \$COMPOSE_ENV_FILE exec -T backend wget --no-verbose --tries=1 --spider http://localhost:8080/api/v1/actuator/health 2>&1 || docker-compose -f \$COMPOSE_FILE -f \$COMPOSE_ENV_FILE exec -T backend curl -f http://localhost:8080/api/v1/actuator/health 2>&1; then
                  echo "Health check passed!"
                  exit 0
                fi
              else
                if ! docker-compose -f \$COMPOSE_FILE ps backend | grep -q "Up"; then
                  echo "Container is not running. Checking logs..."
                  docker-compose -f \$COMPOSE_FILE logs --tail=50 backend
                  sleep 10
                  continue
                fi
                # Health check ì‹œë„
                if docker-compose -f \$COMPOSE_FILE exec -T backend wget --no-verbose --tries=1 --spider http://localhost:8080/api/v1/actuator/health 2>&1 || docker-compose -f \$COMPOSE_FILE exec -T backend curl -f http://localhost:8080/api/v1/actuator/health 2>&1; then
                  echo "Health check passed!"
                  exit 0
                fi
              fi
              sleep 10
            done
            echo "Health check failed after 15 attempts"
            echo "=== Final Backend Logs ==="
            if [ -n "\$COMPOSE_ENV_FILE" ]; then
              docker-compose -f \$COMPOSE_FILE -f \$COMPOSE_ENV_FILE logs --tail=100 backend
            else
              docker-compose -f \$COMPOSE_FILE logs --tail=100 backend
            fi
            exit 1
          REMOTE_SCRIPT
        env:
          DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}

      - name: Health Check (External) - Optional
        continue-on-error: true
        run: |
          DEPLOY_ENV="${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}"
          if [ "$DEPLOY_ENV" = "prod" ]; then
            SERVER_URL='${{ secrets.SERVER_URL_PROD }}'
          else
            SERVER_URL='${{ secrets.SERVER_URL_DEV }}'
          fi
          echo "Checking external health endpoint..."
          echo "DEPLOY_ENV: $DEPLOY_ENV"
          echo "SERVER_URL: ${SERVER_URL:0:20}..." # ì²˜ìŒ 20ìžë§Œ í‘œì‹œ
          # SERVER_URLì´ ë¹„ì–´ìžˆê±°ë‚˜ ìž˜ëª»ëœ í˜•ì‹ì¸ì§€ í™•ì¸
          if [ -z "$SERVER_URL" ] || [ "$SERVER_URL" = "null" ] || [[ "$SERVER_URL" == *"***"* ]]; then
            echo "SERVER_URL not properly set, skipping external health check"
            exit 0
          fi
          # SERVER_URLì—ì„œ ë„ë©”ì¸ ì¶”ì¶œ (https://api.example.com/api/v1 -> https://api.example.com)
          SERVER_DOMAIN=$(echo "$SERVER_URL" | sed 's|https\?://||' | sed 's|/.*||')
          if [ -n "$SERVER_DOMAIN" ] && [ "$SERVER_DOMAIN" != "null" ]; then
            curl -f https://${SERVER_DOMAIN}/api/v1/actuator/health || echo "External health check failed"
          else
            echo "SERVER_URL not set, skipping external health check"
          fi

      - name: Deployment Summary
        run: |
          DEPLOY_ENV="${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}"
          if [ "$DEPLOY_ENV" = "prod" ]; then
            SERVER_URL='${{ secrets.SERVER_URL_PROD }}'
            ENV_NAME="í”„ë¡œë•ì…˜"
          else
            SERVER_URL='${{ secrets.SERVER_URL_DEV }}'
            ENV_NAME="ê°œë°œ"
          fi
          SERVER_DOMAIN=$(echo "$SERVER_URL" | sed 's|https\?://||' | sed 's|/.*||' 2>/dev/null || echo "")
          echo "## ðŸš€ $ENV_NAME ë°°í¬ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **í™˜ê²½**: $ENV_NAME" >> $GITHUB_STEP_SUMMARY
          if [ -n "$SERVER_DOMAIN" ] && [ "$SERVER_DOMAIN" != "null" ] && [[ ! "$SERVER_DOMAIN" == *"***"* ]]; then
            echo "- **ì„œë²„**: $SERVER_DOMAIN" >> $GITHUB_STEP_SUMMARY
            echo "- **API URL**: $SERVER_URL" >> $GITHUB_STEP_SUMMARY
            echo "- **Health Check**: $SERVER_URL/actuator/health" >> $GITHUB_STEP_SUMMARY
            echo "- **Swagger UI**: $SERVER_URL/swagger-ui/index.html" >> $GITHUB_STEP_SUMMARY
          else
            DEPLOY_ENV_UPPER=$(echo "$DEPLOY_ENV" | tr '[:lower:]' '[:upper:]')
            echo "- **ì„œë²„**: GitHub Secretsì—ì„œ SERVER_URL_${DEPLOY_ENV_UPPER} ì„¤ì • í•„ìš”" >> $GITHUB_STEP_SUMMARY
            echo "- **API URL**: ì„¤ì •ë˜ì§€ ì•ŠìŒ" >> $GITHUB_STEP_SUMMARY
          fi

