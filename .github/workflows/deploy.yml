name: Deploy to Server

on:
  push:
    branches:
      - main     # ÌîÑÎ°úÎçïÏÖò Î∞∞Ìè¨
      - release  # ÌîÑÎ°úÎçïÏÖò Î∞∞Ìè¨
      - develop   # Í∞úÎ∞ú ÌôòÍ≤Ω Î∞∞Ìè¨
  workflow_dispatch: # ÏàòÎèô Ïã§Ìñâ (ÌôòÍ≤Ω ÏÑ†ÌÉù Í∞ÄÎä•)
    inputs:
      environment:
        description: 'Î∞∞Ìè¨ ÌôòÍ≤Ω ÏÑ†ÌÉù'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy:
    name: Deploy to ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'Production' || github.event.inputs.environment == 'prod' && 'Production' || 'Development' }} Server
    runs-on: ubuntu-latest
    env:
      DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create remote directory
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ~/taba_backend"

      - name: Create Firebase service account key file
        run: |
          mkdir -p src/main/resources
          cat > src/main/resources/firebase-service-account.json << 'EOF'
          ${{ secrets.FCM_SERVICE_ACCOUNT_KEY_JSON }}
          EOF

      - name: Copy files to server
        run: |
          scp -o StrictHostKeyChecking=no docker-compose.dev.yml docker-compose.prod.yml Dockerfile ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/taba_backend/
          scp -o StrictHostKeyChecking=no build.gradle settings.gradle gradle.properties ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/taba_backend/
          scp -r -o StrictHostKeyChecking=no gradle ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/taba_backend/
          scp -r -o StrictHostKeyChecking=no src ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/taba_backend/

      - name: Deploy Application
        run: |
          DEPLOY_ENV_VALUE="${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}"
          
          # GitHub Secrets Í∞íÏùÑ ÌôòÍ≤Ω Î≥ÄÏàò ÌååÏùºÎ°ú ÏÉùÏÑ±ÌïòÏó¨ Ï†ÑÎã¨
          if [ "$DEPLOY_ENV_VALUE" = "prod" ]; then
            echo "DB_NAME=${{ secrets.DB_NAME_PROD }}" > /tmp/env_vars.txt
            echo "DB_USERNAME=${{ secrets.DB_USERNAME_PROD }}" >> /tmp/env_vars.txt
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD_PROD }}" >> /tmp/env_vars.txt
            echo "JWT_SECRET=${{ secrets.JWT_SECRET_PROD }}" >> /tmp/env_vars.txt
            echo "SERVER_URL=${{ secrets.SERVER_URL_PROD }}" >> /tmp/env_vars.txt
            echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_PROD }}" >> /tmp/env_vars.txt
            echo "EXTERNAL_PORT=${{ secrets.EXTERNAL_PORT_PROD }}" >> /tmp/env_vars.txt
            echo "DB_EXTERNAL_PORT=${{ secrets.DB_EXTERNAL_PORT_PROD }}" >> /tmp/env_vars.txt
            echo "REDIS_EXTERNAL_PORT=${{ secrets.REDIS_EXTERNAL_PORT_PROD }}" >> /tmp/env_vars.txt
          else
            echo "DB_NAME=${{ secrets.DB_NAME_DEV }}" > /tmp/env_vars.txt
            echo "DB_USERNAME=${{ secrets.DB_USERNAME_DEV }}" >> /tmp/env_vars.txt
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD_DEV }}" >> /tmp/env_vars.txt
            echo "JWT_SECRET=${{ secrets.JWT_SECRET_DEV }}" >> /tmp/env_vars.txt
            echo "SERVER_URL=${{ secrets.SERVER_URL_DEV }}" >> /tmp/env_vars.txt
            echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_DEV }}" >> /tmp/env_vars.txt
            echo "EXTERNAL_PORT=${{ secrets.EXTERNAL_PORT_DEV }}" >> /tmp/env_vars.txt
            echo "DB_EXTERNAL_PORT=${{ secrets.DB_EXTERNAL_PORT_DEV }}" >> /tmp/env_vars.txt
            echo "REDIS_EXTERNAL_PORT=${{ secrets.REDIS_EXTERNAL_PORT_DEV }}" >> /tmp/env_vars.txt
          fi
          JWT_EXPIRATION_VAL="${{ secrets.JWT_EXPIRATION }}"
          
          # ÌôòÍ≤Ω Î≥ÄÏàò ÌååÏùºÏùÑ ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°
          scp -o StrictHostKeyChecking=no /tmp/env_vars.txt "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/taba_backend/.env_vars"
          
          ssh -o StrictHostKeyChecking=no "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" JWT_EXPIRATION_VAL="$JWT_EXPIRATION_VAL" DEPLOY_ENV_VALUE="$DEPLOY_ENV_VALUE" bash << 'REMOTE_SCRIPT'
            cd ~/taba_backend
            
            # ÌôòÍ≤Ω Î≥ÄÏàò ÌååÏùºÏóêÏÑú ÏùΩÏñ¥ÏÑú export
            if [ -f .env_vars ]; then
              while IFS='=' read -r key value; do
                if [ -n "$key" ] && [ -n "$value" ]; then
                  export "$key=$value"
                fi
              done < .env_vars
              rm -f .env_vars
            fi
            
            # JWT_EXPIRATION ÏÑ§Ï†ï
            export JWT_EXPIRATION="$JWT_EXPIRATION_VAL"
            [ -z "$JWT_EXPIRATION" ] && export JWT_EXPIRATION=604800000
            
            # ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏
            echo "=== ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏ ==="
            echo "DB_NAME: \${DB_NAME:+ÏÑ§Ï†ïÎê®}\${DB_NAME:-ÎØ∏ÏÑ§Ï†ï}"
            echo "DB_USERNAME: \${DB_USERNAME:+ÏÑ§Ï†ïÎê®}\${DB_USERNAME:-ÎØ∏ÏÑ§Ï†ï}"
            echo "DB_PASSWORD: \${DB_PASSWORD:+ÏÑ§Ï†ïÎê®}\${DB_PASSWORD:-ÎØ∏ÏÑ§Ï†ï}"
            echo "JWT_SECRET: \${JWT_SECRET:+ÏÑ§Ï†ïÎê®}\${JWT_SECRET:-ÎØ∏ÏÑ§Ï†ï}"
            echo "SERVER_URL: \${SERVER_URL:+ÏÑ§Ï†ïÎê®}\${SERVER_URL:-ÎØ∏ÏÑ§Ï†ï}"
            
            # ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
            export DEPLOY_ENV="$DEPLOY_ENV_VALUE"
            echo "=== Î∞∞Ìè¨ ÌôòÍ≤Ω: \$DEPLOY_ENV ==="
            
            # ÌôòÍ≤ΩÎ≥Ñ ÏÑ§Ï†ï
            if [ "\$DEPLOY_ENV" = "prod" ]; then
              # ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤Ω ÏÑ§Ï†ï
              echo "=== ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤Ω ÏÑ§Ï†ï ==="
              
              # Ìè¨Ìä∏ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï (Ïô∏Î∂Ä Ï†ëÏÜç Ìè¨Ìä∏ - Í∞úÎ∞ú ÌôòÍ≤ΩÍ≥º Îã§Î¶Ñ)
              # ‚ö†Ô∏è ÌîÑÎ°úÎçïÏÖò: Backend(8080), MySQL(3306), Redis(6379)
              [ -z "\$EXTERNAL_PORT" ] && export EXTERNAL_PORT=8080
              [ -z "\$DB_EXTERNAL_PORT" ] && export DB_EXTERNAL_PORT=3306
              [ -z "\$REDIS_EXTERNAL_PORT" ] && export REDIS_EXTERNAL_PORT=6379
              [ -z "\$REDIS_PASSWORD" ] && export REDIS_PASSWORD=
              
              export SPRING_PROFILES_ACTIVE=prod
              COMPOSE_FILE="docker-compose.prod.yml"
              BACKEND_CONTAINER="taba-backend-prod"
              MYSQL_CONTAINER="taba-mysql-prod"
              REDIS_CONTAINER="taba-redis-prod"
            else
              # Í∞úÎ∞ú ÌôòÍ≤Ω ÏÑ§Ï†ï
              echo "=== Í∞úÎ∞ú ÌôòÍ≤Ω ÏÑ§Ï†ï ==="
              
              # Ìè¨Ìä∏ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï (Ïô∏Î∂Ä Ï†ëÏÜç Ìè¨Ìä∏ - ÌîÑÎ°úÎçïÏÖòÍ≥º Îã§Î¶Ñ)
              # ‚ö†Ô∏è Í∞úÎ∞ú: Backend(8081), MySQL(3307), Redis(6380) - ÎèôÏãú Ïã§Ìñâ Í∞ÄÎä•
              [ -z "\$EXTERNAL_PORT" ] && export EXTERNAL_PORT=8081
              [ -z "\$DB_EXTERNAL_PORT" ] && export DB_EXTERNAL_PORT=3307
              [ -z "\$REDIS_EXTERNAL_PORT" ] && export REDIS_EXTERNAL_PORT=6380
              [ -z "\$REDIS_PASSWORD" ] && export REDIS_PASSWORD=
              
              export SPRING_PROFILES_ACTIVE=dev
              COMPOSE_FILE="docker-compose.dev.yml"
              BACKEND_CONTAINER="taba-backend-dev"
              MYSQL_CONTAINER="taba-mysql-dev"
              REDIS_CONTAINER="taba-redis-dev"
            fi
            
            # ÌïÑÏàò ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏
            echo "=== ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏ ==="
            echo "DEPLOY_ENV: \$DEPLOY_ENV"
            echo "DB_NAME: \${DB_NAME:+ÏÑ§Ï†ïÎê®}\${DB_NAME:-ÎØ∏ÏÑ§Ï†ï}"
            echo "DB_USERNAME: \${DB_USERNAME:+ÏÑ§Ï†ïÎê®}\${DB_USERNAME:-ÎØ∏ÏÑ§Ï†ï}"
            echo "DB_PASSWORD: \${DB_PASSWORD:+ÏÑ§Ï†ïÎê®}\${DB_PASSWORD:-ÎØ∏ÏÑ§Ï†ï}"
            echo "JWT_SECRET: \${JWT_SECRET:+ÏÑ§Ï†ïÎê®}\${JWT_SECRET:-ÎØ∏ÏÑ§Ï†ï}"
            echo "SERVER_URL: \${SERVER_URL:+ÏÑ§Ï†ïÎê®}\${SERVER_URL:-ÎØ∏ÏÑ§Ï†ï}"
            
            if [ -z "\$DB_NAME" ] || [ -z "\$DB_USERNAME" ] || [ -z "\$DB_PASSWORD" ] || [ -z "\$JWT_SECRET" ] || [ -z "\$SERVER_URL" ]; then
              echo "‚ùå ÌïÑÏàò ÌôòÍ≤Ω Î≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."
              exit 1
            fi
            
            # Í≥µÌÜµ ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
            export DB_HOST=mysql DB_PORT=3306 REDIS_HOST=redis REDIS_PORT=6379 SERVER_PORT=8080 FILE_UPLOAD_DIR=/app/uploads
            export JWT_EXPIRATION="\$JWT_EXPIRATION_VAL"
            [ -z "\$JWT_EXPIRATION" ] && export JWT_EXPIRATION=604800000
            
            # docker-compose Î™ÖÎ†πÏñ¥ ÏÑ§Ï†ï
            echo "=== Docker Compose ÌååÏùº: \$COMPOSE_FILE ==="
            echo "=== Î∞±ÏóîÎìú Ïª®ÌÖåÏù¥ÎÑà: \$BACKEND_CONTAINER ==="
            echo "=== MySQL Ïª®ÌÖåÏù¥ÎÑà: \$MYSQL_CONTAINER ==="
            echo "=== Redis Ïª®ÌÖåÏù¥ÎÑà: \$REDIS_CONTAINER ==="
            COMPOSE_CMD="docker-compose -f \$COMPOSE_FILE"
            
            # MySQL ÏÇ¨Ïö©Ïûê ÏÉùÏÑ± Ìï®Ïàò (ÌôòÍ≤Ω Î≥ÄÏàò ÏßÅÏ†ë Ï∞∏Ï°∞)
            ensure_mysql_user() {
              # ÌôòÍ≤Ω Î≥ÄÏàò ÏßÅÏ†ë Ï∞∏Ï°∞ (Ìï®Ïàò ÎÇ¥Î∂ÄÏóêÏÑúÎèÑ Ï†ëÍ∑º Í∞ÄÎä•ÌïòÎèÑÎ°ù)
              local mysql_container=\$MYSQL_CONTAINER
              
              # ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏
              if [ -z "\$DB_NAME" ] || [ -z "\$DB_USERNAME" ] || [ -z "\$DB_PASSWORD" ]; then
                echo "‚ùå ÌôòÍ≤Ω Î≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§: DB_NAME=\${DB_NAME:-ÎπÑÏñ¥ÏûàÏùå}, DB_USERNAME=\${DB_USERNAME:-ÎπÑÏñ¥ÏûàÏùå}, DB_PASSWORD=\${DB_PASSWORD:+ÏÑ§Ï†ïÎê®}\${DB_PASSWORD:-ÎπÑÏñ¥ÏûàÏùå}"
                return 1
              fi
              
              echo "Creating MySQL user: \$DB_USERNAME for database: \$DB_NAME"
              
              local root_pass=\$(docker exec \$mysql_container printenv MYSQL_ROOT_PASSWORD 2>/dev/null || echo "\$DB_PASSWORD")
              local root_test=\$(docker exec \$mysql_container mysql -u root -p"\$root_pass" -e "SELECT 1" 2>&1) || true
              
              if echo "\$root_test" | grep -qiE "(ERROR|Access denied|denied)"; then
                root_pass="\$DB_PASSWORD"
                root_test=\$(docker exec \$mysql_container mysql -u root -p"\$root_pass" -e "SELECT 1" 2>&1) || true
              fi
              
              if ! echo "\$root_test" | grep -qiE "(ERROR|Access denied|denied)"; then
                echo "Executing: CREATE DATABASE IF NOT EXISTS \`\$DB_NAME\`"
                docker exec \$mysql_container mysql -u root -p"\$root_pass" -e "CREATE DATABASE IF NOT EXISTS \`\$DB_NAME\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" 2>&1 | grep -v "Warning" || true
                
                echo "Executing: DROP USER IF EXISTS '\$DB_USERNAME'@'%'"
                docker exec \$mysql_container mysql -u root -p"\$root_pass" -e "DROP USER IF EXISTS '\$DB_USERNAME'@'%';" 2>&1 | grep -v "Warning" || true
                
                echo "Executing: CREATE USER '\$DB_USERNAME'@'%'"
                docker exec \$mysql_container mysql -u root -p"\$root_pass" -e "CREATE USER '\$DB_USERNAME'@'%' IDENTIFIED BY '\$DB_PASSWORD';" 2>&1 | grep -v "Warning" || true
                
                echo "Executing: GRANT ALL PRIVILEGES ON \`\$DB_NAME\`.* TO '\$DB_USERNAME'@'%'"
                docker exec \$mysql_container mysql -u root -p"\$root_pass" -e "GRANT ALL PRIVILEGES ON \`\$DB_NAME\`.* TO '\$DB_USERNAME'@'%'; FLUSH PRIVILEGES;" 2>&1 | grep -v "Warning" || true
                
                echo "‚úÖ MySQL user and database created successfully"
              else
                echo "‚ùå Cannot connect to MySQL as root: \$root_test"
                return 1
              fi
            }
            
            # Î∞±ÏóîÎìú Ï§ëÏßÄ Î∞è ÎπåÎìú
            echo "=== Stopping and removing backend container ==="
            docker stop "\$BACKEND_CONTAINER" 2>/dev/null || true
            docker rm -f "\$BACKEND_CONTAINER" 2>/dev/null || true
            
            echo "=== Pre-build checks ==="
            echo "Current directory: \$(pwd)"
            echo "Files in directory:"
            ls -la | head -20
            echo ""
            echo "Docker Compose command: \$COMPOSE_CMD"
            echo "Compose file: \$COMPOSE_FILE"
            echo ""
            echo "Checking required files:"
            [ -f "\$COMPOSE_FILE" ] && echo "‚úÖ \$COMPOSE_FILE exists" || echo "‚ùå \$COMPOSE_FILE NOT FOUND"
            [ -f "Dockerfile" ] && echo "‚úÖ Dockerfile exists" || echo "‚ùå Dockerfile NOT FOUND"
            [ -f "build.gradle" ] && echo "‚úÖ build.gradle exists" || echo "‚ùå build.gradle NOT FOUND"
            [ -d "src" ] && echo "‚úÖ src directory exists" || echo "‚ùå src directory NOT FOUND"
            [ -d "gradle" ] && echo "‚úÖ gradle directory exists" || echo "‚ùå gradle directory NOT FOUND"
            echo ""
            
            echo "=== Building backend image ==="
            # ÎπåÎìú Ïã§Ìñâ Î∞è ÏÉÅÏÑ∏ Î°úÍ∑∏ Ï∂úÎ†•
            if ! \$COMPOSE_CMD build --no-cache --progress=plain backend 2>&1 | tee /tmp/build.log; then
              echo ""
              echo "‚ùå Backend build failed"
              echo "=== Build log (last 200 lines) ==="
              tail -200 /tmp/build.log || true
              echo ""
              echo "=== Error summary ==="
              grep -i "error\|failed\|exception" /tmp/build.log | tail -50 || echo "No error patterns found"
              echo ""
              echo "=== Docker Compose file check ==="
              ls -la \$COMPOSE_FILE || echo "Compose file not found: \$COMPOSE_FILE"
              echo "=== Dockerfile check ==="
              ls -la Dockerfile || echo "Dockerfile not found"
              exit 1
            fi
            echo "‚úÖ Backend build completed successfully"
            
            # MySQL, Redis ÏãúÏûë
            echo "=== Creating network ==="
            docker network create taba-network 2>/dev/null || true
            
            echo "=== Stopping existing MySQL/Redis containers ==="
            docker stop "\$MYSQL_CONTAINER" "\$REDIS_CONTAINER" 2>/dev/null || true
            docker rm -f "\$MYSQL_CONTAINER" "\$REDIS_CONTAINER" 2>/dev/null || true
            
            echo "=== Cleaning up with docker-compose down ==="
            \$COMPOSE_CMD down --remove-orphans 2>/dev/null || true
            
            echo "=== Starting MySQL and Redis ==="
            \$COMPOSE_CMD up -d mysql redis || {
              echo "‚ùå Failed to start MySQL/Redis"
              \$COMPOSE_CMD logs mysql redis
              exit 1
            }
            sleep 10
            
            # MySQL ÏÇ¨Ïö©Ïûê ÏÉùÏÑ± Î∞è ÌÖåÏä§Ìä∏
            echo "=== Waiting for MySQL to be healthy ==="
            for i in {1..12}; do
              HEALTH_STATUS=\$(docker inspect --format='{{.State.Health.Status}}' "\$MYSQL_CONTAINER" 2>/dev/null || echo "unknown")
              echo "MySQL health check attempt \$i/12: \$HEALTH_STATUS"
              if [ "\$HEALTH_STATUS" = "healthy" ]; then
                echo "‚úÖ MySQL is healthy"
                break
              fi
              if [ \$i -eq 12 ]; then
                echo "‚ùå MySQL failed to become healthy after 60 seconds"
                docker logs --tail=50 "\$MYSQL_CONTAINER" 2>&1
                exit 1
              fi
              sleep 5
            done
            
            echo "=== Ensuring MySQL user and database ==="
            ensure_mysql_user
            
            # ÏÇ¨Ïö©Ïûê Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
            echo "=== Testing MySQL connection ==="
            echo "Testing connection with: DB_NAME=\$DB_NAME, DB_USERNAME=\$DB_USERNAME"
            
            # ÌôòÍ≤Ω Î≥ÄÏàò Ïû¨ÌôïÏù∏
            if [ -z "\$DB_NAME" ] || [ -z "\$DB_USERNAME" ] || [ -z "\$DB_PASSWORD" ]; then
              echo "‚ùå ÌôòÍ≤Ω Î≥ÄÏàòÍ∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§!"
              echo "DB_NAME: '\$DB_NAME'"
              echo "DB_USERNAME: '\$DB_USERNAME'"
              echo "DB_PASSWORD: '\${DB_PASSWORD:+ÏÑ§Ï†ïÎê®}'\${DB_PASSWORD:-ÎπÑÏñ¥ÏûàÏùå}"
              exit 1
            fi
            
            for retry in {1..3}; do
              echo "Connection attempt \$retry/3: mysql -u \$DB_USERNAME -p*** -e \"USE \`\$DB_NAME\`; SELECT 1;\""
              USER_TEST=\$(docker exec \$MYSQL_CONTAINER mysql -u "\$DB_USERNAME" -p"\$DB_PASSWORD" -e "USE \`\$DB_NAME\`; SELECT 1;" 2>&1) || true
              
              if ! echo "\$USER_TEST" | grep -qiE "(ERROR|Access denied|denied|must be followed)"; then
                echo "‚úÖ MySQL connection successful"
                break
              fi
              
              echo "MySQL connection attempt \$retry/3 failed"
              echo "Test output: \$USER_TEST"
              
              if [ \$retry -lt 3 ]; then
                echo "Retrying user creation..."
                ensure_mysql_user
                sleep 3
              else
                echo "‚ùå MySQL connection failed after 3 attempts"
                echo "Final connection test output: \$USER_TEST"
                echo "=== Current environment variables ==="
                echo "DB_NAME: '\$DB_NAME'"
                echo "DB_USERNAME: '\$DB_USERNAME'"
                echo "DB_PASSWORD: '\${DB_PASSWORD:+ÏÑ§Ï†ïÎê®}'\${DB_PASSWORD:-ÎπÑÏñ¥ÏûàÏùå}"
                echo "MYSQL_CONTAINER: '\$MYSQL_CONTAINER'"
                echo "=== MySQL container environment ==="
                docker exec \$MYSQL_CONTAINER printenv | grep MYSQL || true
                echo "=== MySQL logs (last 50 lines) ==="
                docker logs --tail=50 \$MYSQL_CONTAINER 2>&1
                exit 1
              fi
            done
            
            # Î∞±ÏóîÎìú ÏãúÏûë Ï†Ñ ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏
            echo "=== ÌôòÍ≤Ω Î≥ÄÏàò ÏµúÏ¢Ö ÌôïÏù∏ (Î∞±ÏóîÎìú ÏãúÏûë Ï†Ñ) ==="
            echo "DB_HOST: \$DB_HOST"
            echo "DB_NAME: \$DB_NAME"
            echo "DB_USERNAME: \$DB_USERNAME"
            echo "DB_PASSWORD: \${DB_PASSWORD:0:3}***"
            echo "JWT_SECRET: \${JWT_SECRET:0:10}***"
            echo "SERVER_URL: \$SERVER_URL"
            echo "SPRING_PROFILES_ACTIVE: \$SPRING_PROFILES_ACTIVE"
            echo ""
            
            # Î∞±ÏóîÎìú ÏãúÏûë
            echo "=== Starting backend ==="
            \$COMPOSE_CMD up -d backend || {
              echo "‚ùå Failed to start backend"
              echo "=== Docker Compose logs ==="
              \$COMPOSE_CMD logs backend 2>&1 || true
              echo ""
              echo "=== Container environment variables ==="
              docker exec "\$BACKEND_CONTAINER" printenv | grep -E "(DB_|JWT_|SERVER_|SPRING_)" || echo "Container not running"
              exit 1
            }
            sleep 5
            echo "=== Backend container environment variables ==="
            docker exec "\$BACKEND_CONTAINER" printenv | grep -E "(DB_|JWT_|SERVER_|SPRING_)" | sort || echo "Container not ready yet"
            echo ""
            echo "=== Backend logs (last 50 lines) ==="
            docker logs --tail=50 "\$BACKEND_CONTAINER" 2>&1 || echo "No logs available"
          REMOTE_SCRIPT

      - name: Check container status
        run: |
          ssh -o StrictHostKeyChecking=no "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" bash << 'REMOTE_SCRIPT'
            cd ~/taba_backend
            BACKEND_CONTAINER=$([ "$DEPLOY_ENV" = "prod" ] && echo "taba-backend-prod" || echo "taba-backend-dev")
            echo "=== Container Status ==="
            docker ps -a --filter "name=taba" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
            echo ""
            echo "=== Backend Logs ==="
            docker logs --tail=50 "$BACKEND_CONTAINER" 2>&1 || echo "No logs"
          REMOTE_SCRIPT
        env:
          DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}

      - name: Health Check (Internal)
        continue-on-error: true
        run: |
          ssh -o StrictHostKeyChecking=no "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" bash << 'REMOTE_SCRIPT'
            BACKEND_CONTAINER=$([ "$DEPLOY_ENV" = "prod" ] && echo "taba-backend-prod" || echo "taba-backend-dev")
            sleep 60
            for i in {1..10}; do
              docker ps | grep -q "$BACKEND_CONTAINER" && docker exec "$BACKEND_CONTAINER" curl -f http://localhost:8080/api/v1/actuator/health 2>&1 && exit 0
              sleep 10
            done
            docker logs --tail=50 "$BACKEND_CONTAINER" 2>&1
            exit 1
          REMOTE_SCRIPT
        env:
          DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}

      - name: Health Check (External) - Optional
        continue-on-error: true
        run: |
          DEPLOY_ENV="${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}"
          if [ "$DEPLOY_ENV" = "prod" ]; then
            SERVER_URL='${{ secrets.SERVER_URL_PROD }}'
          else
            SERVER_URL='${{ secrets.SERVER_URL_DEV }}'
          fi
          echo "Checking external health endpoint..."
          echo "DEPLOY_ENV: $DEPLOY_ENV"
          echo "SERVER_URL: ${SERVER_URL:0:30}..." # Ï≤òÏùå 30ÏûêÎßå ÌëúÏãú
          
          # SERVER_URLÏù¥ ÎπÑÏñ¥ÏûàÍ±∞ÎÇò ÏûòÎ™ªÎêú ÌòïÏãùÏù∏ÏßÄ ÌôïÏù∏
          if [ -z "$SERVER_URL" ] || [ "$SERVER_URL" = "null" ] || [[ "$SERVER_URL" == *"***"* ]]; then
            echo "‚ö†Ô∏è SERVER_URL not properly set, skipping external health check"
            exit 0
          fi
          
          # SERVER_URLÏóêÏÑú ÎèÑÎ©îÏù∏ Ï∂îÏ∂ú (https://www.taba.asia/api/v1 -> https://www.taba.asia)
          SERVER_DOMAIN=$(echo "$SERVER_URL" | sed 's|https\?://||' | sed 's|/.*||')
          
          if [ -n "$SERVER_DOMAIN" ] && [ "$SERVER_DOMAIN" != "null" ]; then
            echo "Testing: https://${SERVER_DOMAIN}/api/v1/actuator/health"
            # ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï Î∞è Ïû¨ÏãúÎèÑ
            for i in {1..3}; do
              if curl -f --max-time 10 --connect-timeout 5 "https://${SERVER_DOMAIN}/api/v1/actuator/health" 2>&1; then
                echo "‚úÖ External health check passed"
                exit 0
              fi
              echo "Attempt $i/3 failed, retrying in 5 seconds..."
              sleep 5
            done
            echo "‚ùå External health check failed after 3 attempts"
            echo "‚ö†Ô∏è This might be normal if Nginx is not configured yet or SSL certificate is pending"
          else
            echo "SERVER_URL not set, skipping external health check"
          fi

      - name: Deployment Summary
        run: |
          DEPLOY_ENV="${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}"
          if [ "$DEPLOY_ENV" = "prod" ]; then
            SERVER_URL='${{ secrets.SERVER_URL_PROD }}'
            ENV_NAME="ÌîÑÎ°úÎçïÏÖò"
          else
            SERVER_URL='${{ secrets.SERVER_URL_DEV }}'
            ENV_NAME="Í∞úÎ∞ú"
          fi
          SERVER_DOMAIN=$(echo "$SERVER_URL" | sed 's|https\?://||' | sed 's|/.*||' 2>/dev/null || echo "")
          echo "## üöÄ $ENV_NAME Î∞∞Ìè¨ ÏôÑÎ£å!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ÌôòÍ≤Ω**: $ENV_NAME" >> $GITHUB_STEP_SUMMARY
          if [ -n "$SERVER_DOMAIN" ] && [ "$SERVER_DOMAIN" != "null" ] && [[ ! "$SERVER_DOMAIN" == *"***"* ]]; then
            echo "- **ÏÑúÎ≤Ñ**: $SERVER_DOMAIN" >> $GITHUB_STEP_SUMMARY
            echo "- **API URL**: $SERVER_URL" >> $GITHUB_STEP_SUMMARY
            echo "- **Health Check**: $SERVER_URL/actuator/health" >> $GITHUB_STEP_SUMMARY
            echo "- **Swagger UI**: $SERVER_URL/swagger-ui/index.html" >> $GITHUB_STEP_SUMMARY
          else
            DEPLOY_ENV_UPPER=$(echo "$DEPLOY_ENV" | tr '[:lower:]' '[:upper:]')
            echo "- **ÏÑúÎ≤Ñ**: GitHub SecretsÏóêÏÑú SERVER_URL_${DEPLOY_ENV_UPPER} ÏÑ§Ï†ï ÌïÑÏöî" >> $GITHUB_STEP_SUMMARY
            echo "- **API URL**: ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏùå" >> $GITHUB_STEP_SUMMARY
          fi

