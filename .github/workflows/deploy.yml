name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  deploy:
    name: Deploy to cobyserver.iptime.org
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H cobyserver.iptime.org >> ~/.ssh/known_hosts

      - name: Create remote directory
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@cobyserver.iptime.org "mkdir -p ~/taba_backend"

      - name: Create Firebase service account key file
        run: |
          mkdir -p src/main/resources
          cat > src/main/resources/firebase-service-account.json << 'EOF'
          ${{ secrets.FCM_SERVICE_ACCOUNT_KEY_JSON }}
          EOF

      - name: Copy files to server
        run: |
          scp -o StrictHostKeyChecking=no docker-compose.yml docker-compose.prod.yml Dockerfile ${{ secrets.SSH_USER }}@cobyserver.iptime.org:~/taba_backend/
          scp -o StrictHostKeyChecking=no build.gradle settings.gradle gradle.properties ${{ secrets.SSH_USER }}@cobyserver.iptime.org:~/taba_backend/
          scp -r -o StrictHostKeyChecking=no gradle ${{ secrets.SSH_USER }}@cobyserver.iptime.org:~/taba_backend/
          scp -r -o StrictHostKeyChecking=no src ${{ secrets.SSH_USER }}@cobyserver.iptime.org:~/taba_backend/

      - name: Deploy with Docker Compose
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@cobyserver.iptime.org bash << 'REMOTE_SCRIPT'
            cd ~/taba_backend
            export DB_HOST=mysql
            export DB_PORT=3306
            export DB_NAME='${{ secrets.DB_NAME }}'
            export DB_USERNAME='${{ secrets.DB_USERNAME }}'
            export DB_PASSWORD='${{ secrets.DB_PASSWORD }}'
            export REDIS_HOST=redis
            export REDIS_PORT=6379
            export REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD }}'
            export JWT_SECRET='${{ secrets.JWT_SECRET }}'
            export JWT_EXPIRATION='${{ secrets.JWT_EXPIRATION }}'
            export SERVER_PORT=8080
            export SERVER_URL='${{ secrets.SERVER_URL }}'
            export EXTERNAL_PORT=8080
            export SPRING_PROFILES_ACTIVE=prod
            export FILE_UPLOAD_DIR=/app/uploads
            # ì„ íƒì‚¬í•­ Secrets ê¸°ë³¸ê°’ ì²˜ë¦¬
            [ -z "$JWT_EXPIRATION" ] && export JWT_EXPIRATION=604800000
            [ -z "$REDIS_PASSWORD" ] && export REDIS_PASSWORD=
            # í™˜ê²½ ë³€ìˆ˜ í™•ì¸ (ë””ë²„ê¹…ìš©, ë¹„ë°€ë²ˆí˜¸ëŠ” ì¼ë¶€ë§Œ í‘œì‹œ)
            echo "=== Environment Variables Check ==="
            echo "DB_NAME=$DB_NAME"
            echo "DB_USERNAME=$DB_USERNAME"
            echo "DB_PASSWORD=${DB_PASSWORD:0:3}***"
            echo "JWT_SECRET=${JWT_SECRET:0:10}***"
            echo "SERVER_URL=$SERVER_URL"
            echo "================================"
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml pull || true
            # ê¸°ì¡´ ì´ë¯¸ì§€ ì œê±° í›„ ìž¬ë¹Œë“œ
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml down || true
            docker rmi taba_backend-backend 2>/dev/null || true
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache --pull backend
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
            echo "=== Container Status After Start ==="
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
            echo "=== Backend Logs (first 50 lines) ==="
            sleep 5
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail=50 backend || true
          REMOTE_SCRIPT

      - name: Check container status
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@cobyserver.iptime.org bash << 'REMOTE_SCRIPT'
            cd ~/taba_backend
            echo "=== Container Status ==="
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
            echo ""
            echo "=== Backend Logs (last 100 lines) ==="
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail=100 backend || true
            echo ""
            echo "=== Backend Logs (with timestamps, last 200 lines) ==="
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail=200 --timestamps backend 2>&1 | tail -50 || true
          REMOTE_SCRIPT

      - name: Health Check (Internal)
        continue-on-error: true
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@cobyserver.iptime.org bash << 'REMOTE_SCRIPT'
            cd ~/taba_backend
            echo "Waiting for application to start..."
            sleep 60
            for i in {1..15}; do
              echo "Health check attempt $i/15 (internal)..."
              # ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
              if ! docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps backend | grep -q "Up"; then
                echo "Container is not running. Checking logs..."
                docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail=50 backend
                sleep 10
                continue
              fi
              # Health check ì‹œë„
              if docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T backend wget --no-verbose --tries=1 --spider http://localhost:8080/api/v1/actuator/health 2>&1 || docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T backend curl -f http://localhost:8080/api/v1/actuator/health 2>&1; then
                echo "Health check passed!"
                exit 0
              fi
              sleep 10
            done
            echo "Health check failed after 15 attempts"
            echo "=== Final Backend Logs ==="
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail=100 backend
            exit 1
          REMOTE_SCRIPT

      - name: Health Check (External) - Optional
        continue-on-error: true
        run: |
          echo "Checking external health endpoint..."
          curl -f http://cobyserver.iptime.org:8080/api/v1/actuator/health || echo "External health check failed (may be due to firewall/port forwarding)"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ ë°°í¬ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ì„œë²„**: cobyserver.iptime.org" >> $GITHUB_STEP_SUMMARY
          echo "- **í¬íŠ¸**: 8080" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: http://cobyserver.iptime.org:8080/api/v1" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check**: http://cobyserver.iptime.org:8080/api/v1/actuator/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Swagger UI**: http://cobyserver.iptime.org:8080/api/v1/swagger-ui/index.html" >> $GITHUB_STEP_SUMMARY

