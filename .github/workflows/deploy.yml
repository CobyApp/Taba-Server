name: Deploy to Server

on:
  push:
    branches:
      - main     # í”„ë¡œë•ì…˜ ë°°í¬
      - release  # í”„ë¡œë•ì…˜ ë°°í¬
      - develop   # ê°œë°œ í™˜ê²½ ë°°í¬
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ (í™˜ê²½ ì„ íƒ ê°€ëŠ¥)
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy:
    name: Deploy to ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'Production' || github.event.inputs.environment == 'prod' && 'Production' || 'Development' }} Server
    runs-on: ubuntu-latest
    env:
      DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create Firebase service account key file
        run: |
          mkdir -p src/main/resources
          cat > src/main/resources/firebase-service-account.json << 'EOF'
          ${{ secrets.FCM_SERVICE_ACCOUNT_KEY_JSON }}
          EOF

      - name: Copy files to server
        run: |
          DEPLOY_ENV_VALUE="${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}"
          
          # í™˜ê²½ë³„ ë””ë ‰í† ë¦¬ ì„¤ì • (ê° í™˜ê²½ì´ ì™„ì „íˆ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘)
          if [ "$DEPLOY_ENV_VALUE" = "prod" ]; then
            REMOTE_DIR="~/taba_backend_prod"
            echo "=== Copying files to production directory: $REMOTE_DIR ==="
          else
            REMOTE_DIR="~/taba_backend_dev"
            echo "=== Copying files to development directory: $REMOTE_DIR ==="
          fi
          
          # ì›ê²© ë””ë ‰í† ë¦¬ ìƒì„±
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p $REMOTE_DIR"
          
          # í™˜ê²½ë³„ë¡œ í•„ìš”í•œ íŒŒì¼ë§Œ ë³µì‚¬ (ë‹¤ë¥¸ í™˜ê²½ íŒŒì¼ì€ ë³µì‚¬í•˜ì§€ ì•ŠìŒ)
          if [ "$DEPLOY_ENV_VALUE" = "prod" ]; then
            echo "=== Copying production files only ==="
            scp -o StrictHostKeyChecking=no docker-compose.prod.yml Dockerfile ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$REMOTE_DIR/
          else
            echo "=== Copying development files only ==="
            scp -o StrictHostKeyChecking=no docker-compose.dev.yml Dockerfile ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$REMOTE_DIR/
          fi
          
          # ê³µí†µ íŒŒì¼ ë³µì‚¬ (ê° í™˜ê²½ì˜ ë…ë¦½ ë””ë ‰í† ë¦¬ì—)
          scp -o StrictHostKeyChecking=no build.gradle settings.gradle gradle.properties ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$REMOTE_DIR/
          scp -r -o StrictHostKeyChecking=no gradle ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$REMOTE_DIR/
          scp -r -o StrictHostKeyChecking=no src ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$REMOTE_DIR/

      - name: Deploy Application
        run: |
          DEPLOY_ENV_VALUE="${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}"
          ssh -o StrictHostKeyChecking=no "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" DEPLOY_ENV="$DEPLOY_ENV_VALUE" bash << 'REMOTE_SCRIPT'
            # í™˜ê²½ë³„ ë””ë ‰í† ë¦¬ ì„¤ì • (ê° í™˜ê²½ì´ ì™„ì „íˆ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘)
            if [ "$DEPLOY_ENV" = "prod" ]; then
              DEPLOY_DIR="$HOME/taba_backend_prod"
            else
              DEPLOY_DIR="$HOME/taba_backend_dev"
            fi
            
            cd "$DEPLOY_DIR"
            echo "=== Working directory: $DEPLOY_DIR ==="
            echo "=== Current directory: $(pwd) ==="
            
            # í™˜ê²½ë³„ ì„¤ì • (ê° í™˜ê²½ì€ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘)
            if [ "$DEPLOY_ENV" = "prod" ]; then
              echo "=== Production environment configuration ==="
              export DB_NAME="${{ secrets.DB_NAME_PROD }}"
              export DB_USERNAME="${{ secrets.DB_USERNAME_PROD }}"
              export DB_PASSWORD="${{ secrets.DB_PASSWORD_PROD }}"
              export REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD_PROD }}"
              export JWT_SECRET="${{ secrets.JWT_SECRET_PROD }}"
              export SERVER_URL="${{ secrets.SERVER_URL_PROD }}"
              export EXTERNAL_PORT="${{ secrets.EXTERNAL_PORT_PROD }}"
              export DB_EXTERNAL_PORT="${{ secrets.DB_EXTERNAL_PORT_PROD }}"
              export REDIS_EXTERNAL_PORT="${{ secrets.REDIS_EXTERNAL_PORT_PROD }}"
              # í¬íŠ¸ ê¸°ë³¸ê°’ ì„¤ì • (í”„ë¡œë•ì…˜: Backend(8080), MySQL(3306), Redis(6379))
              [ -z "$EXTERNAL_PORT" ] && export EXTERNAL_PORT=8080
              [ -z "$DB_EXTERNAL_PORT" ] && export DB_EXTERNAL_PORT=3306
              [ -z "$REDIS_EXTERNAL_PORT" ] && export REDIS_EXTERNAL_PORT=6379
              export SPRING_PROFILES_ACTIVE=prod
              COMPOSE_FILE="docker-compose.prod.yml"
              BACKEND_CONTAINER="taba-backend-prod"
              MYSQL_CONTAINER="taba-mysql-prod"
              REDIS_CONTAINER="taba-redis-prod"
              echo "âœ… Using production compose file: $COMPOSE_FILE"
              echo "âœ… Production containers: $BACKEND_CONTAINER, $MYSQL_CONTAINER, $REDIS_CONTAINER"
            else
              echo "=== Development environment configuration ==="
              export DB_NAME="${{ secrets.DB_NAME_DEV }}"
              export DB_USERNAME="${{ secrets.DB_USERNAME_DEV }}"
              export DB_PASSWORD="${{ secrets.DB_PASSWORD_DEV }}"
              export REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD_DEV }}"
              export JWT_SECRET="${{ secrets.JWT_SECRET_DEV }}"
              export SERVER_URL="${{ secrets.SERVER_URL_DEV }}"
              export EXTERNAL_PORT="${{ secrets.EXTERNAL_PORT_DEV }}"
              export DB_EXTERNAL_PORT="${{ secrets.DB_EXTERNAL_PORT_DEV }}"
              export REDIS_EXTERNAL_PORT="${{ secrets.REDIS_EXTERNAL_PORT_DEV }}"
              # í¬íŠ¸ ê¸°ë³¸ê°’ ì„¤ì • (ê°œë°œ: Backend(8081), MySQL(3307), Redis(6380) - ë™ì‹œ ì‹¤í–‰ ê°€ëŠ¥)
              [ -z "$EXTERNAL_PORT" ] && export EXTERNAL_PORT=8081
              [ -z "$DB_EXTERNAL_PORT" ] && export DB_EXTERNAL_PORT=3307
              [ -z "$REDIS_EXTERNAL_PORT" ] && export REDIS_EXTERNAL_PORT=6380
              export SPRING_PROFILES_ACTIVE=dev
              COMPOSE_FILE="docker-compose.dev.yml"
              BACKEND_CONTAINER="taba-backend-dev"
              MYSQL_CONTAINER="taba-mysql-dev"
              REDIS_CONTAINER="taba-redis-dev"
              echo "âœ… Using development compose file: $COMPOSE_FILE"
              echo "âœ… Development containers: $BACKEND_CONTAINER, $MYSQL_CONTAINER, $REDIS_CONTAINER"
            fi
            
            # ë‹¤ë¥¸ í™˜ê²½ì˜ ì»¨í…Œì´ë„ˆëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒì„ í™•ì¸
            echo "=== Ensuring other environment containers are not affected ==="
            if [ "$DEPLOY_ENV" = "prod" ]; then
              DEV_BACKEND=$(docker ps --format '{{.Names}}' | grep "^taba-backend-dev$" || echo "")
              DEV_MYSQL=$(docker ps --format '{{.Names}}' | grep "^taba-mysql-dev$" || echo "")
              DEV_REDIS=$(docker ps --format '{{.Names}}' | grep "^taba-redis-dev$" || echo "")
              if [ -n "$DEV_BACKEND" ] || [ -n "$DEV_MYSQL" ] || [ -n "$DEV_REDIS" ]; then
                echo "âœ… Development environment containers are running (will not be affected):"
                [ -n "$DEV_BACKEND" ] && echo "  - $DEV_BACKEND"
                [ -n "$DEV_MYSQL" ] && echo "  - $DEV_MYSQL"
                [ -n "$DEV_REDIS" ] && echo "  - $DEV_REDIS"
              fi
            else
              PROD_BACKEND=$(docker ps --format '{{.Names}}' | grep "^taba-backend-prod$" || echo "")
              PROD_MYSQL=$(docker ps --format '{{.Names}}' | grep "^taba-mysql-prod$" || echo "")
              PROD_REDIS=$(docker ps --format '{{.Names}}' | grep "^taba-redis-prod$" || echo "")
              if [ -n "$PROD_BACKEND" ] || [ -n "$PROD_MYSQL" ] || [ -n "$PROD_REDIS" ]; then
                echo "âœ… Production environment containers are running (will not be affected):"
                [ -n "$PROD_BACKEND" ] && echo "  - $PROD_BACKEND"
                [ -n "$PROD_MYSQL" ] && echo "  - $PROD_MYSQL"
                [ -n "$PROD_REDIS" ] && echo "  - $PROD_REDIS"
              fi
            fi
            
            # í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ í™•ì¸
            if [ -z "$DB_NAME" ] || [ -z "$DB_USERNAME" ] || [ -z "$DB_PASSWORD" ] || [ -z "$JWT_SECRET" ] || [ -z "$SERVER_URL" ]; then
              echo "âŒ í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              echo "DB_NAME: ${DB_NAME:+ì„¤ì •ë¨}${DB_NAME:-ë¯¸ì„¤ì •}"
              echo "DB_USERNAME: ${DB_USERNAME:+ì„¤ì •ë¨}${DB_USERNAME:-ë¯¸ì„¤ì •}"
              echo "DB_PASSWORD: ${DB_PASSWORD:+ì„¤ì •ë¨}${DB_PASSWORD:-ë¯¸ì„¤ì •}"
              echo "JWT_SECRET: ${JWT_SECRET:+ì„¤ì •ë¨}${JWT_SECRET:-ë¯¸ì„¤ì •}"
              echo "SERVER_URL: ${SERVER_URL:+ì„¤ì •ë¨}${SERVER_URL:-ë¯¸ì„¤ì •}"
              exit 1
            fi
            
            export DB_HOST=mysql DB_PORT=3306 REDIS_HOST=redis REDIS_PORT=6379 SERVER_PORT=8080 FILE_UPLOAD_DIR=/app/uploads
            export JWT_EXPIRATION=${JWT_EXPIRATION:-604800000}
            [ -z "$REDIS_PASSWORD" ] && export REDIS_PASSWORD=
            
            COMPOSE_CMD="docker-compose -f $COMPOSE_FILE"
            
            # MySQL ì‚¬ìš©ì ìƒì„± í•¨ìˆ˜
            ensure_mysql_user() {
              local mysql_container="$MYSQL_CONTAINER"
              local db_name="$DB_NAME"
              local db_username="$DB_USERNAME"
              local db_password="$DB_PASSWORD"
              
              local root_pass=$(docker exec "$mysql_container" printenv MYSQL_ROOT_PASSWORD 2>/dev/null || echo "$db_password")
              local root_test=$(docker exec "$mysql_container" mysql -u root -p"$root_pass" -e "SELECT 1" 2>&1) || true
              
              if echo "$root_test" | grep -qiE "(ERROR|Access denied|denied)"; then
                root_pass="$db_password"
                root_test=$(docker exec "$mysql_container" mysql -u root -p"$root_pass" -e "SELECT 1" 2>&1) || true
              fi
              
              if ! echo "$root_test" | grep -qiE "(ERROR|Access denied|denied)"; then
                docker exec "$mysql_container" mysql -u root -p"$root_pass" -e "CREATE DATABASE IF NOT EXISTS \`$db_name\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" 2>&1 | grep -v "Warning" >/dev/null || true
                docker exec "$mysql_container" mysql -u root -p"$root_pass" -e "DROP USER IF EXISTS '$db_username'@'%';" 2>&1 | grep -v "Warning" >/dev/null || true
                docker exec "$mysql_container" mysql -u root -p"$root_pass" -e "CREATE USER '$db_username'@'%' IDENTIFIED BY '$db_password';" 2>&1 | grep -v "Warning" >/dev/null || true
                docker exec "$mysql_container" mysql -u root -p"$root_pass" -e "GRANT ALL PRIVILEGES ON \`$db_name\`.* TO '$db_username'@'%'; FLUSH PRIVILEGES;" 2>&1 | grep -v "Warning" >/dev/null || true
              fi
            }
            
            # ê³µìœ  ë„¤íŠ¸ì›Œí¬ ìƒì„± (prod/dev ëª¨ë‘ ì‚¬ìš©, ì´ë¯¸ ì¡´ì¬í•˜ë©´ ë¬´ì‹œ)
            docker network create taba-network 2>/dev/null || true
            
            # í˜„ì¬ í™˜ê²½ì˜ ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆë§Œ ì¤‘ì§€ ë° ì œê±° (ë‹¤ë¥¸ í™˜ê²½ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
            echo "=== Stopping current environment backend container ==="
            docker stop "$BACKEND_CONTAINER" 2>/dev/null || true
            docker rm -f "$BACKEND_CONTAINER" 2>/dev/null || true
            
            # ì†ìƒëœ ì´ë¯¸ì§€ ì œê±° (ContainerConfig ì—ëŸ¬ ë°©ì§€)
            echo "=== Removing old backend image to prevent ContainerConfig errors ==="
            # docker-composeê°€ ì‚¬ìš©í•˜ëŠ” ì´ë¯¸ì§€ ì´ë¦„ ì°¾ê¸° (í”„ë¡œì íŠ¸ëª…-ì„œë¹„ìŠ¤ëª… í˜•ì‹)
            COMPOSE_PROJECT_NAME=$(basename "$(pwd)" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g')
            OLD_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "${COMPOSE_PROJECT_NAME}.*backend|.*backend.*${COMPOSE_PROJECT_NAME}" | head -1 || echo "")
            if [ -z "$OLD_IMAGE" ]; then
              # ëŒ€ì²´ ë°©ë²•: <none> íƒœê·¸ê°€ ìˆëŠ” ì´ë¯¸ì§€ ì°¾ê¸°
              OLD_IMAGE=$(docker images --format "{{.ID}}" --filter "dangling=true" | head -1 || echo "")
              if [ -n "$OLD_IMAGE" ]; then
                echo "Removing dangling image: $OLD_IMAGE"
                docker rmi -f "$OLD_IMAGE" 2>/dev/null || true
              fi
            else
              echo "Removing old backend image: $OLD_IMAGE"
              docker rmi -f "$OLD_IMAGE" 2>/dev/null || true
            fi
            # ì†ìƒëœ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì°¸ì¡° ì •ë¦¬
            docker container prune -f 2>/dev/null || true
            
            # ë°±ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ
            echo "=== Building backend image ==="
            $COMPOSE_CMD build --no-cache --progress=plain backend || exit 1
            
            # í˜„ì¬ í™˜ê²½ì˜ MySQL/Redis ì»¨í…Œì´ë„ˆë§Œ ì™„ì „íˆ ì œê±° (ë‹¤ë¥¸ í™˜ê²½ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
            echo "=== Stopping and removing current environment MySQL/Redis containers ==="
            # ì—¬ëŸ¬ ë²ˆ ì‹œë„í•˜ì—¬ ì™„ì „íˆ ì œê±°
            for attempt in {1..3}; do
              docker stop "$MYSQL_CONTAINER" "$REDIS_CONTAINER" 2>/dev/null || true
              docker rm -f "$MYSQL_CONTAINER" "$REDIS_CONTAINER" 2>/dev/null || true
              sleep 1
              # ì»¨í…Œì´ë„ˆê°€ ì™„ì „íˆ ì œê±°ë˜ì—ˆëŠ”ì§€ í™•ì¸
              if ! docker ps -a --format '{{.Names}}' | grep -q "^${MYSQL_CONTAINER}$" && \
                 ! docker ps -a --format '{{.Names}}' | grep -q "^${REDIS_CONTAINER}$"; then
                echo "âœ… Containers removed successfully"
                break
              fi
              if [ $attempt -eq 3 ]; then
                echo "âš ï¸ Some containers may still exist, but continuing..."
              fi
            done
            
            # MySQL, Redis ì‹œì‘ (ë‹¤ë¥¸ í™˜ê²½ì˜ ì»¨í…Œì´ë„ˆëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)
            echo "=== Starting MySQL and Redis for current environment ==="
            # --force-recreate ì˜µì…˜ìœ¼ë¡œ ContainerConfig ì—ëŸ¬ ë°©ì§€
            $COMPOSE_CMD up -d --force-recreate mysql redis
            
            # ì»¨í…Œì´ë„ˆê°€ ì‹¤ì œë¡œ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ì¬ì‹œì‘ í¬í•¨)
            echo "=== Waiting for containers to start ==="
            for i in {1..60}; do
              MYSQL_RUNNING=$(docker ps --format '{{.Names}}' | grep -q "^${MYSQL_CONTAINER}$" && echo "yes" || echo "no")
              REDIS_RUNNING=$(docker ps --format '{{.Names}}' | grep -q "^${REDIS_CONTAINER}$" && echo "yes" || echo "no")
              
              if [ "$MYSQL_RUNNING" = "yes" ] && [ "$REDIS_RUNNING" = "yes" ]; then
                echo "âœ… Containers are running"
                break
              fi
              
              # ì¢…ë£Œëœ ì»¨í…Œì´ë„ˆê°€ ìˆìœ¼ë©´ ì¬ì‹œì‘ ì‹œë„
              if [ "$MYSQL_RUNNING" = "no" ]; then
                MYSQL_STATUS=$(docker ps -a --format '{{.Names}} {{.Status}}' | grep "^${MYSQL_CONTAINER} " || echo "")
                if [ -n "$MYSQL_STATUS" ]; then
                  echo "âš ï¸ MySQL container not running: $MYSQL_STATUS, attempting restart..."
                  docker start "$MYSQL_CONTAINER" 2>/dev/null || $COMPOSE_CMD up -d --no-deps mysql
                fi
              fi
              
              if [ "$REDIS_RUNNING" = "no" ]; then
                REDIS_STATUS=$(docker ps -a --format '{{.Names}} {{.Status}}' | grep "^${REDIS_CONTAINER} " || echo "")
                if [ -n "$REDIS_STATUS" ]; then
                  echo "âš ï¸ Redis container not running: $REDIS_STATUS, attempting restart..."
                  docker logs --tail=20 "$REDIS_CONTAINER" 2>&1 || true
                  docker start "$REDIS_CONTAINER" 2>/dev/null || $COMPOSE_CMD up -d --no-deps redis
                fi
              fi
              
              if [ $i -eq 60 ]; then
                echo "âŒ Containers failed to start after 60 seconds"
                echo "=== Container status ==="
                docker ps -a | grep -E "${MYSQL_CONTAINER}|${REDIS_CONTAINER}" || true
                echo "=== MySQL logs ==="
                docker logs --tail=30 "$MYSQL_CONTAINER" 2>&1 || true
                echo "=== Redis logs ==="
                docker logs --tail=30 "$REDIS_CONTAINER" 2>&1 || true
                exit 1
              fi
              sleep 2
            done
            
            # MySQL health check ëŒ€ê¸°
            echo "=== Waiting for MySQL to be healthy ==="
            for i in {1..60}; do
              HEALTH_STATUS=$(docker inspect --format='{{.State.Health.Status}}' "$MYSQL_CONTAINER" 2>/dev/null || echo "unknown")
              echo "MySQL health check attempt $i/60: $HEALTH_STATUS"
              if [ "$HEALTH_STATUS" = "healthy" ]; then
                echo "âœ… MySQL is healthy"
                break
              fi
              if [ $i -eq 60 ]; then
                echo "âŒ MySQL failed to become healthy after 60 attempts"
                docker logs --tail=50 "$MYSQL_CONTAINER" 2>&1 || true
                exit 1
              fi
              sleep 2
            done
            
            ensure_mysql_user
            
            # ì‚¬ìš©ì ì—°ê²° í…ŒìŠ¤íŠ¸
            for retry in {1..3}; do
              USER_TEST=$(docker exec "$MYSQL_CONTAINER" mysql -u "$DB_USERNAME" -p"$DB_PASSWORD" -e "USE \`$DB_NAME\`; SELECT 1;" 2>&1) || true
              if ! echo "$USER_TEST" | grep -qiE "(ERROR|Access denied|denied)"; then
                echo "âœ… MySQL connection successful"
                break
              fi
              if [ $retry -lt 3 ]; then
                ensure_mysql_user
                sleep 3
              else
                echo "âŒ MySQL connection failed"
                docker logs --tail=30 "$MYSQL_CONTAINER" 2>&1
                exit 1
              fi
            done
            
            # ë°±ì—”ë“œ ì‹œì‘ (MySQL/RedisëŠ” ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë¯€ë¡œ --no-deps ì‚¬ìš©)
            echo "=== Starting backend ==="
            # MySQL/Redisê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
            if ! docker ps --format '{{.Names}}' | grep -q "^${MYSQL_CONTAINER}$" || \
               ! docker ps --format '{{.Names}}' | grep -q "^${REDIS_CONTAINER}$"; then
              echo "âŒ MySQL or Redis container is not running"
              docker ps --format '{{.Names}}' | grep -E "${MYSQL_CONTAINER}|${REDIS_CONTAINER}" || true
              exit 1
            fi
            echo "âœ… MySQL and Redis are running, starting backend..."
            # --force-recreate ì˜µì…˜ìœ¼ë¡œ ContainerConfig ì—ëŸ¬ ë°©ì§€
            $COMPOSE_CMD up -d --no-deps --force-recreate backend || exit 1
            sleep 5
            echo "=== Backend logs ==="
            docker logs --tail=30 "$BACKEND_CONTAINER" 2>&1
          REMOTE_SCRIPT
        env:
          DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}

      - name: Check container status
        run: |
          DEPLOY_ENV_VALUE="${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}"
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} DEPLOY_ENV="$DEPLOY_ENV_VALUE" bash << 'REMOTE_SCRIPT'
            # í™˜ê²½ë³„ ë””ë ‰í† ë¦¬ ì„¤ì •
            if [ "$DEPLOY_ENV" = "prod" ]; then
              DEPLOY_DIR="$HOME/taba_backend_prod"
            else
              DEPLOY_DIR="$HOME/taba_backend_dev"
            fi
            cd "$DEPLOY_DIR"
            BACKEND_CONTAINER=$([ "$DEPLOY_ENV" = "prod" ] && echo "taba-backend-prod" || echo "taba-backend-dev")
            echo "=== Container Status ==="
            docker ps -a --filter "name=taba" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
            echo ""
            echo "=== Backend Logs ==="
            docker logs --tail=50 "$BACKEND_CONTAINER" 2>&1 || echo "No logs"
          REMOTE_SCRIPT
        env:
          DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}

      - name: Health Check (Internal)
        continue-on-error: true
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash << 'REMOTE_SCRIPT'
            BACKEND_CONTAINER=$([ "$DEPLOY_ENV" = "prod" ] && echo "taba-backend-prod" || echo "taba-backend-dev")
            sleep 60
            for i in {1..10}; do
              docker ps | grep -q "$BACKEND_CONTAINER" && docker exec "$BACKEND_CONTAINER" curl -f http://localhost:8080/api/v1/actuator/health 2>&1 && exit 0
              sleep 10
            done
            docker logs --tail=50 "$BACKEND_CONTAINER" 2>&1
            exit 1
          REMOTE_SCRIPT
        env:
          DEPLOY_ENV: ${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}

      - name: Health Check (External) - Optional
        continue-on-error: true
        run: |
          DEPLOY_ENV="${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}"
          if [ "$DEPLOY_ENV" = "prod" ]; then
            SERVER_URL='${{ secrets.SERVER_URL_PROD }}'
          else
            SERVER_URL='${{ secrets.SERVER_URL_DEV }}'
          fi
          echo "Checking external health endpoint..."
          echo "DEPLOY_ENV: $DEPLOY_ENV"
          echo "SERVER_URL: ${SERVER_URL:0:20}..." # ì²˜ìŒ 20ìë§Œ í‘œì‹œ
          # SERVER_URLì´ ë¹„ì–´ìˆê±°ë‚˜ ì˜ëª»ëœ í˜•ì‹ì¸ì§€ í™•ì¸
          if [ -z "$SERVER_URL" ] || [ "$SERVER_URL" = "null" ] || [[ "$SERVER_URL" == *"***"* ]]; then
            echo "SERVER_URL not properly set, skipping external health check"
            exit 0
          fi
          # SERVER_URLì—ì„œ ë„ë©”ì¸ ì¶”ì¶œ (https://api.example.com/api/v1 -> https://api.example.com)
          SERVER_DOMAIN=$(echo "$SERVER_URL" | sed 's|https\?://||' | sed 's|/.*||')
          if [ -n "$SERVER_DOMAIN" ] && [ "$SERVER_DOMAIN" != "null" ]; then
            curl -f https://${SERVER_DOMAIN}/api/v1/actuator/health || echo "External health check failed"
          else
            echo "SERVER_URL not set, skipping external health check"
          fi

      - name: Deployment Summary
        run: |
          DEPLOY_ENV="${{ (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main') && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.environment == 'prod' && 'prod' || github.event.inputs.environment == 'dev' && 'dev' || 'dev' }}"
          if [ "$DEPLOY_ENV" = "prod" ]; then
            SERVER_URL='${{ secrets.SERVER_URL_PROD }}'
            ENV_NAME="í”„ë¡œë•ì…˜"
          else
            SERVER_URL='${{ secrets.SERVER_URL_DEV }}'
            ENV_NAME="ê°œë°œ"
          fi
          SERVER_DOMAIN=$(echo "$SERVER_URL" | sed 's|https\?://||' | sed 's|/.*||' 2>/dev/null || echo "")
          echo "## ğŸš€ $ENV_NAME ë°°í¬ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **í™˜ê²½**: $ENV_NAME" >> $GITHUB_STEP_SUMMARY
          if [ -n "$SERVER_DOMAIN" ] && [ "$SERVER_DOMAIN" != "null" ] && [[ ! "$SERVER_DOMAIN" == *"***"* ]]; then
            echo "- **ì„œë²„**: $SERVER_DOMAIN" >> $GITHUB_STEP_SUMMARY
            echo "- **API URL**: $SERVER_URL" >> $GITHUB_STEP_SUMMARY
            echo "- **Health Check**: $SERVER_URL/actuator/health" >> $GITHUB_STEP_SUMMARY
            echo "- **Swagger UI**: $SERVER_URL/swagger-ui/index.html" >> $GITHUB_STEP_SUMMARY
          else
            DEPLOY_ENV_UPPER=$(echo "$DEPLOY_ENV" | tr '[:lower:]' '[:upper:]')
            echo "- **ì„œë²„**: GitHub Secretsì—ì„œ SERVER_URL_${DEPLOY_ENV_UPPER} ì„¤ì • í•„ìš”" >> $GITHUB_STEP_SUMMARY
            echo "- **API URL**: ì„¤ì •ë˜ì§€ ì•ŠìŒ" >> $GITHUB_STEP_SUMMARY
          fi
